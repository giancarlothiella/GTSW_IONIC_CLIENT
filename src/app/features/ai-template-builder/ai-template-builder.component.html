<!-- AI Template Builder Component Template -->
<p-toast position="bottom-right"></p-toast>

<div class="ai-template-builder">

  <!-- HEADER -->
  <div class="builder-header">
    <div class="header-left">
      <h2>
        <i class="pi pi-file-pdf"></i>
        {{t(1000, 'AI Template Builder')}}
        @if (hasUnsavedChanges) {
          <span class="unsaved-indicator" title="Ci sono modifiche non salvate">
            <i class="pi pi-exclamation-circle"></i>
            {{t(1350, 'Non salvato')}}
          </span>
        }
      </h2>
      <!-- Sottotitolo dinamico in base alla modalità -->
      @if (mode === 'fromReport' && sessionData) {
        <p class="header-subtitle">
          {{t(1002, 'Session')}} #{{sessionData.sessionId}} |
          {{t(1003, 'Report')}}: {{sessionData.reportCode}} |
          {{t(1004, 'Project')}}: {{sessionData.prjId}}
        </p>
      }
      @if (mode === 'edit' && existingTemplate) {
        <p class="header-subtitle">
          {{t(1005, 'Edit')}}: {{existingTemplate.prjId}} / {{existingTemplate.connCode}} / {{existingTemplate.reportCode}} - {{existingTemplate.reportName}}
          @if (existingTemplate.version) {
            <span class="version-badge">v{{existingTemplate.version}}</span>
          }
        </p>
      }
      @if (mode === 'newWithMock') {
        <p class="header-subtitle">
          {{t(1006, 'Nuovo template da dati Mock JSON')}}
        </p>
      }
      @if (mode === 'newWithPdf') {
        <p class="header-subtitle">
          {{t(1007, 'Nuovo template da PDF esterno')}}
        </p>
      }
      @if (!modeSelected) {
        <p class="header-subtitle">
          {{t(1008, 'Seleziona modalità di creazione')}}
        </p>
      }
    </div>
    <div class="header-right">
      <!-- Rigenera Template AI - visibile solo quando siamo in preview/editing -->
      @if (currentStep === 'preview' || currentStep === 'editing') {
        <button pButton
                type="button"
                [label]="t(1355, 'Rigenera Template')"
                icon="pi pi-sync"
                class="p-button-warning"
                [disabled]="loading || regeneratingTemplate"
                [pTooltip]="t(1356, 'Rigenera il template HTML con AI usando i dati già caricati')"
                tooltipPosition="bottom"
                (click)="regenerateTemplateAI()"></button>
      }
    </div>
  </div>

  <!-- LOADING OVERLAY -->
  @if (loading) {
    <div class="loading-overlay-container">
      <div class="loading-overlay" [class.analyzing]="currentStep === 'analyzing'">

        <!-- Spinner animato -->
        @if (currentStep !== 'analyzing') {
          <div class="loader-icon">
            <p-progressSpinner></p-progressSpinner>
          </div>
        }

        <!-- AI Animation per analisi -->
        @if (currentStep === 'analyzing') {
          <div class="ai-loader">
            <div class="ai-brain">
              <i class="pi pi-sparkles"></i>
            </div>
            <div class="ai-pulse"></div>
            <div class="ai-pulse delay-1"></div>
            <div class="ai-pulse delay-2"></div>
          </div>
        }

        <!-- Messaggio principale -->
        <p class="loading-title">{{loadingMessage}}</p>

        <!-- Timer e info durante analisi -->
        @if (currentStep === 'analyzing') {
          <div class="analysis-info">
        <div class="elapsed-time">
          <i class="pi pi-clock"></i>
          <span class="time-value">{{elapsedTimeFormatted}}</span>
        </div>
        <div class="analysis-steps">
          <div class="step-item" [class.active]="elapsedSeconds < 10" [class.done]="elapsedSeconds >= 10">
            <i class="pi" [class.pi-spin]="elapsedSeconds < 10" [class.pi-spinner]="elapsedSeconds < 10" [class.pi-check]="elapsedSeconds >= 10"></i>
            {{t(1020, 'Invio richiesta a Claude AI')}}
          </div>
          <div class="step-item" [class.active]="elapsedSeconds >= 10 && elapsedSeconds < 30" [class.done]="elapsedSeconds >= 30">
            <i class="pi" [class.pi-spin]="elapsedSeconds >= 10 && elapsedSeconds < 30" [class.pi-spinner]="elapsedSeconds >= 10 && elapsedSeconds < 30" [class.pi-check]="elapsedSeconds >= 30"></i>
            {{t(1021, 'Analisi struttura dati')}}
          </div>
          <div class="step-item" [class.active]="elapsedSeconds >= 30 && elapsedSeconds < 60" [class.done]="elapsedSeconds >= 60">
            <i class="pi" [class.pi-spin]="elapsedSeconds >= 30 && elapsedSeconds < 60" [class.pi-spinner]="elapsedSeconds >= 30 && elapsedSeconds < 60" [class.pi-check]="elapsedSeconds >= 60"></i>
            {{t(1022, 'Generazione template HTML')}}
          </div>
          <div class="step-item" [class.active]="elapsedSeconds >= 60">
            <i class="pi" [class.pi-spin]="elapsedSeconds >= 60" [class.pi-spinner]="elapsedSeconds >= 60"></i>
            {{t(1023, 'Finalizzazione regole...')}}
          </div>
        </div>
          <small class="patience-note">
            <i class="pi pi-info-circle"></i>
            {{t(1024, "L'analisi AI può richiedere 30 secondi - 3 minuti in base alla complessità")}}
          </small>
          </div>
        }

      </div>
    </div>
  }

  <!-- STEPS INDICATOR - Rimosso: era ridondante -->

  <!-- MAIN CONTENT -->
  <div class="builder-content">

    <!-- ========================================== -->
    <!-- STEP 0: SELEZIONE MODALITÀ -->
    <!-- ========================================== -->
    @if (currentStep === 'mode') {
    <div class="step-panel">
      <p-card [header]="t(1040, 'Seleziona Modalità di Creazione')">
        <div class="mode-selection-grid">

          <!-- Opzione: Nuovo da Mock JSON -->
          <div class="mode-card" (click)="selectMode('newWithMock')">
            <div class="mode-icon">
              <i class="pi pi-database"></i>
            </div>
            <div class="mode-content">
              <h3>{{t(1041, 'Nuovo da Mock JSON')}}</h3>
              <p>{{t(1042, 'Carica un file JSON con dati di esempio e genera automaticamente template HTML e regole di aggregazione.')}}</p>
              <ul>
                <li>{{t(1043, 'Ideale se hai già i dati strutturati')}}</li>
                <li>{{t(1044, 'Analisi veloce (10-30 sec)')}}</li>
                <li>{{t(1045, 'Non richiede PDF')}}</li>
              </ul>
            </div>
          </div>

          <!-- Opzione: Nuovo da PDF -->
          <div class="mode-card" (click)="selectMode('newWithPdf')">
            <div class="mode-icon pdf">
              <i class="pi pi-file-pdf"></i>
            </div>
            <div class="mode-content">
              <h3>{{t(1046, 'Nuovo da PDF Esterno')}}</h3>
              <p>{{t(1047, "Carica un PDF di esempio e lascia che l'AI estragga layout, dati mock e struttura automaticamente.")}}</p>
              <ul>
                <li>{{t(1048, 'Ideale per replicare report esistenti')}}</li>
                <li>{{t(1049, 'Estrae dati dal documento')}}</li>
                <li>{{t(1050, 'Analisi completa (1-3 min)')}}</li>
              </ul>
            </div>
          </div>

          <!-- Opzione: Carica Template Esistente (nascosta se arriviamo da pagina esterna) -->
          @if (!hasReturnTo) {
          <div class="mode-card load-existing" (click)="openLoadTemplateDialog()">
            <div class="mode-icon existing">
              <i class="pi pi-folder-open"></i>
            </div>
            <div class="mode-content">
              <h3>{{t(1051, 'Carica Template Esistente')}}</h3>
              <p>{{t(1052, 'Riprendi il lavoro su un template già salvato. Modifica HTML, regole o rigenera con AI.')}}</p>
              <ul>
                <li>{{t(1053, 'Modifica template salvati')}}</li>
                <li>{{t(1054, 'Visualizza PDF sorgente originale')}}</li>
                <li>{{t(1055, 'Continua da dove avevi lasciato')}}</li>
              </ul>
            </div>
          </div>
          }

        </div>
      </p-card>

      <!-- Footer con pulsante Back (solo se arriviamo da pagina esterna) -->
      @if (hasReturnTo) {
        <div class="step-actions back-only">
          <button pButton
                  type="button"
                  [label]="t(1004, 'Indietro')"
                  icon="pi pi-arrow-left"
                  class="p-button-secondary"
                  (click)="goBackToLogs()"></button>
        </div>
      }
    </div>
    }

    <!-- ========================================== -->
    <!-- STEP 1: UPLOAD/SORGENTE DATI -->
    <!-- ========================================== -->
    @if (currentStep === 'upload') {
    <div class="step-panel">

      <!-- ===== MODALITÀ: DA REPORT (fromReport) ===== -->
      @if (mode === 'fromReport') {

      <!-- Session Info Card -->
      <p-card [header]="t(1070, 'Informazioni Sessione')" [style]="{'margin-bottom': '20px'}">
        <div class="info-grid">
          <div class="info-item">
            <label>{{t(1071, 'Session ID')}}:</label>
            <span>{{sessionData?.sessionId}}</span>
          </div>
          <div class="info-item">
            <label>{{t(1072, 'Report Code')}}:</label>
            <span>{{sessionData?.reportCode}}</span>
          </div>
          <div class="info-item">
            <label>{{t(1073, 'SQL ID')}}:</label>
            <span>{{sessionData?.sqlId}}</span>
          </div>
          <div class="info-item">
            <label>{{t(1074, 'Connection')}}:</label>
            <span>{{sessionData?.connCode}}</span>
          </div>
          <div class="info-item">
            <label>{{t(1075, 'Records MAIN')}}:</label>
            <span class="badge badge-info">{{mainRecordsCount}}</span>
          </div>
          <div class="info-item">
            <label>{{t(1076, 'Subreports')}}:</label>
            <span class="badge badge-success">{{subreportsCount}}</span>
          </div>
        </div>
      </p-card>

      <!-- PDF Upload Card -->
      <p-card [header]="t(1077, 'Carica PDF di Riferimento')">

        <!-- Alert quando requireManualPdf è true -->
        @if (requireManualPdf) {
        <div class="manual-pdf-alert">
          <i class="pi pi-info-circle"></i>
          <span>{{t(1097, 'Questa sessione non ha un PDF FastReport. Carica manualmente il PDF generato esternamente.')}}</span>
        </div>
        }

        <!-- Source Selection -->
        <div class="pdf-source-field">
          <label>{{t(1078, 'Origine PDF')}}:</label>
          <p-selectButton [options]="[
            {label: t(1079, 'FastReport Esistente'), value: 'fastReport', disabled: requireManualPdf},
            {label: t(1080, 'PDF Cliente'), value: 'clientPDF'},
            {label: t(1081, 'PDF Sviluppatore'), value: 'developerPDF'}
          ]"
          [(ngModel)]="pdfSource"
          optionLabel="label"
          optionValue="value"
          optionDisabled="disabled">
          </p-selectButton>
          <div class="pdf-source-description">
            @if (pdfSource === 'fastReport' && !requireManualPdf) {
              <span>{{t(1082, 'Usa PDF già generato da FastReport per questa sessione')}}</span>
            }
            @if (pdfSource === 'fastReport' && requireManualPdf) {
              <span>{{t(1098, 'PDF FastReport non disponibile per questa sessione')}}</span>
            }
            @if (pdfSource === 'clientPDF') {
              <span>{{t(1083, 'Carica PDF fornito dal cliente come esempio')}}</span>
            }
            @if (pdfSource === 'developerPDF') {
              <span>{{t(1084, 'Carica PDF di esempio creato dallo sviluppatore')}}</span>
            }
          </div>
        </div>

        <!-- File Upload (se non fastReport) - usa stesso stile di newWithPdf -->
        @if (pdfSource !== 'fastReport') {
        <div class="field" style="margin-top: 20px;">
          <label>{{t(1085, 'Seleziona File PDF')}}:</label>

          <!-- Area Upload PDF (quando non c'è file) -->
          @if (!uploadedPdf) {
          <div class="pdf-upload-area"
               [class.drag-over]="isDraggingPdf"
               (dragover)="onDragOver($event, 'pdf')"
               (dragleave)="onDragLeave($event, 'pdf')"
               (drop)="onDrop($event, 'pdf')">
            <div class="drop-zone-content">
              <i class="pi pi-cloud-upload drop-icon"></i>
              <p class="drop-text">{{t(1121, 'Trascina qui il PDF')}}</p>
              <p class="drop-divider">{{t(1102, 'oppure')}}</p>
              <p-fileUpload
                mode="basic"
                accept="application/pdf"
                [maxFileSize]="10000000"
                [auto]="true"
                [chooseLabel]="t(1086, 'Scegli PDF')"
                chooseIcon="pi pi-upload"
                (onSelect)="onPdfFileSelected($event)">
              </p-fileUpload>
              <p class="upload-hint">
                <i class="pi pi-info-circle"></i>
                {{t(1122, 'Formati accettati: PDF (max 10MB)')}}
              </p>
            </div>
          </div>
          }

          <!-- PDF Caricato (con bottone rimuovi) -->
          @if (uploadedPdf) {
            <div class="uploaded-file-card">
              <div class="file-icon">
                <i class="pi pi-file-pdf"></i>
              </div>
              <div class="file-info">
                <span class="file-name">{{uploadedPdf.file.name}}</span>
                <span class="file-size">({{(uploadedPdf.file.size / 1024).toFixed(0)}} KB)</span>
              </div>
              <button pButton
                      type="button"
                      icon="pi pi-times"
                      [label]="t(1106, 'Rimuovi')"
                      class="p-button-danger p-button-outlined p-button-sm"
                      (click)="removePdf()"></button>
            </div>
          }
        </div>
        }

        <!-- Data Summary -->
        <div class="data-summary">
          <h4><i class="pi pi-database"></i> {{t(1087, 'Riepilogo Dati Oracle')}}</h4>
          <div class="summary-stats">
            <div class="stat-card">
              <div class="stat-value">{{totalRecords}}</div>
              <div class="stat-label">{{t(1088, 'Record Totali')}}</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">{{mainRecordsCount}}</div>
              <div class="stat-label">{{t(1089, 'MAIN')}}</div>
            </div>
            @for (sr of oracleData?.subreports | keyvalue; track sr.key) {
              <div class="stat-card">
                <div class="stat-value">{{sr.value.length}}</div>
                <div class="stat-label">{{sr.key}}</div>
              </div>
            }
          </div>
        </div>

        <!-- User Instructions for AI -->
        <div class="user-instructions-section">
          <div class="user-instructions-header">
            <h4>
              <i class="pi pi-comment"></i> {{t(1400, 'Istruzioni per Claude AI')}}
            </h4>
            <span class="optional-badge">({{t(1401, 'opzionale')}})</span>
          </div>
          <textarea class="user-instructions-textarea"
                    [(ngModel)]="userInstructions"
                    [placeholder]="t(1402, 'Es: Il totale deve essere in grassetto. Raggruppa per CODICE_CLIENTE. I valori negativi in rosso...')"
                    rows="3"
                    [pTooltip]="t(1403, 'Fornisci indicazioni specifiche per guidare la generazione del template')"
                    tooltipPosition="top">
          </textarea>
          <div class="user-instructions-hint">
            <i class="pi pi-info-circle"></i>
            <span>{{t(1404, 'Descrivi punti critici, campi chiave, logica di raggruppamento o formattazione desiderata')}}</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="card-actions">
          <button pButton
                  type="button"
                  [label]="t(1090, 'Torna ai Log')"
                  icon="pi pi-arrow-left"
                  class="p-button-outlined"
                  style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                  (click)="goBackToLogs()"></button>

          <div class="action-buttons">
            <!-- Analisi Veloce (senza PDF) - richiede dati Oracle -->
            <button pButton
                    type="button"
                    [label]="t(1091, 'Analisi Veloce')"
                    icon="pi pi-bolt"
                    class="p-button-success"
                    style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                    [pTooltip]="t(1092, 'Genera template dalla struttura dati Oracle (10-30 sec) - Richiede dati')"
                    tooltipPosition="top"
                    [disabled]="!oracleData"
                    (click)="analyzeSimple()"></button>

            <!-- Analisi Solo PDF - genera mock data dal PDF -->
            <button pButton
                    type="button"
                    [label]="t(1093, 'Solo PDF')"
                    icon="pi pi-file-pdf"
                    class="p-button-warning"
                    style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                    [pTooltip]="t(1094, 'Genera template + mock data dal solo PDF (1-3 min) - Non richiede dati Oracle')"
                    tooltipPosition="top"
                    [disabled]="!uploadedPdf && pdfSource !== 'fastReport'"
                    (click)="analyzePdfOnly()"></button>

            <!-- Analisi completa PDF + Dati Oracle -->
            <button pButton
                    type="button"
                    [label]="t(1095, 'PDF + Dati')"
                    icon="pi pi-sparkles"
                    class="btn-ai-primary"
                    [pTooltip]="t(1096, 'Analizza PDF + dati Oracle per massima precisione (1-3 min)')"
                    tooltipPosition="top"
                    [disabled]="(!uploadedPdf && pdfSource !== 'fastReport') || !oracleData"
                    (click)="analyzeWithAI()"></button>
          </div>
        </div>

      </p-card>
      }

      <!-- ===== MODALITÀ: NUOVO DA MOCK JSON (newWithMock) ===== -->
      @if (mode === 'newWithMock') {
        <p-card [header]="t(1100, 'Carica Dati Mock JSON')">
          <div class="field">
            <label>{{t(1072, 'Report Code')}}:</label>
            <input type="text"
                   pInputText
                   [(ngModel)]="saveConfig.reportCode"
                   [placeholder]="t(1135, 'es: INV01')"
                   style="width: 300px;">
          </div>

          <div class="field" style="margin-top: 20px;">
            <label>{{t(1085, 'Seleziona File JSON')}}:</label>

            <!-- Area Upload JSON (quando non c'è file) -->
            @if (!uploadedMockJson) {
              <div class="json-upload-area"
                   [class.drag-over]="isDraggingJson"
                   (dragover)="onDragOver($event, 'json')"
                   (dragleave)="onDragLeave($event, 'json')"
                   (drop)="onDrop($event, 'json')">
                <div class="drop-zone-content">
                  <i class="pi pi-cloud-upload drop-icon"></i>
                  <p class="drop-text">{{t(1101, 'Trascina qui il JSON')}}</p>
                  <p class="drop-divider">{{t(1102, 'oppure')}}</p>
                  <p-fileUpload
                    mode="basic"
                    accept="application/json"
                    [maxFileSize]="5000000"
                    [auto]="true"
                    [chooseLabel]="t(1103, 'Scegli JSON')"
                    chooseIcon="pi pi-upload"
                    (onSelect)="onMockJsonFileSelected($event)">
                  </p-fileUpload>
                  <p class="upload-hint">
                    <i class="pi pi-info-circle"></i>
                    {{t(1104, 'Formati accettati: JSON (max 5MB)')}}
                  </p>
                </div>
              </div>
            }

            <!-- JSON Caricato (con bottone rimuovi) -->
            @if (uploadedMockJson) {
              <div class="uploaded-file-card json">
                <div class="file-icon">
                  <i class="pi pi-file"></i>
                </div>
                <div class="file-info">
                  <span class="file-name">{{mockDataFileName}}</span>
                  <span class="file-size">{{t(1105, 'JSON valido')}}</span>
                </div>
                <button pButton
                        type="button"
                        icon="pi pi-times"
                        [label]="t(1106, 'Rimuovi')"
                        class="p-button-danger p-button-outlined p-button-sm"
                        (click)="removeMockJson()"></button>
              </div>
            }
          </div>

          <!-- Data Summary (se JSON caricato) -->
          @if (parsedMockData) {
            <div class="data-summary">
              <h4><i class="pi pi-database"></i> {{t(1107, 'Riepilogo Dati Mock')}}</h4>
              <div class="summary-stats">
                <div class="stat-card">
                  <div class="stat-value">{{totalRecords}}</div>
                  <div class="stat-label">{{t(1088, 'Record Totali')}}</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value">{{mainRecordsCount}}</div>
                  <div class="stat-label">{{t(1089, 'MAIN')}}</div>
                </div>
                @for (sr of parsedMockData.subreports | keyvalue; track sr.key) {
                  <div class="stat-card">
                    <div class="stat-value">{{sr.value.length}}</div>
                    <div class="stat-label">{{sr.key}}</div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Info Box (cosa farà l'AI) -->
          <div class="info-box" style="margin-top: 20px;">
            <h5><i class="pi pi-sparkles"></i> {{t(1108, "Cosa farà l'AI")}}:</h5>
            <ul>
              <li><strong>{{t(1109, 'Analisi Struttura')}}</strong> - {{t(1110, 'Esamina campi e tipi di dati')}}</li>
              <li><strong>{{t(1111, 'Template HTML')}}</strong> - {{t(1112, 'Genera layout report professionale')}}</li>
              <li><strong>{{t(1113, 'Aggregation Rules')}}</strong> - {{t(1114, 'Suggerisce raggruppamenti e totali')}}</li>
              <li><strong>{{t(1115, 'Preview')}}</strong> - {{t(1116, 'Mostra anteprima con i tuoi dati')}}</li>
            </ul>
            <p class="time-estimate">
              <i class="pi pi-clock"></i> {{t(1117, 'Tempo stimato: 10-30 secondi')}}
            </p>
          </div>

          <!-- Esempio struttura JSON (collassato quando c'è già un file) -->
          @if (!uploadedMockJson) {
            <div class="json-example-box" style="margin-top: 20px;">
              <h5><i class="pi pi-code"></i> {{t(1118, 'Struttura JSON richiesta')}}:</h5>
              <pre class="json-example-code">{{ jsonExampleText }}</pre>
            </div>
          }

          <!-- User Instructions for AI -->
          <div class="user-instructions-section">
            <div class="user-instructions-header">
              <h4>
                <i class="pi pi-comment"></i> {{t(1400, 'Istruzioni per Claude AI')}}
              </h4>
              <span class="optional-badge">({{t(1401, 'opzionale')}})</span>
            </div>
            <textarea class="user-instructions-textarea"
                      [(ngModel)]="userInstructions"
                      [placeholder]="t(1402, 'Es: Il totale deve essere in grassetto. Raggruppa per CODICE_CLIENTE. I valori negativi in rosso...')"
                      rows="3"
                      [pTooltip]="t(1403, 'Fornisci indicazioni specifiche per guidare la generazione del template')"
                      tooltipPosition="top">
            </textarea>
            <div class="user-instructions-hint">
              <i class="pi pi-info-circle"></i>
              <span>{{t(1404, 'Descrivi punti critici, campi chiave, logica di raggruppamento o formattazione desiderata')}}</span>
            </div>
          </div>

          <!-- Actions -->
          <div class="card-actions">
            <button pButton
                    type="button"
                    [label]="t(1119, 'Indietro')"
                    icon="pi pi-arrow-left"
                    class="p-button-outlined"
                    style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                    (click)="goBackToModeSelection()"></button>

            <button pButton
                    type="button"
                    [label]="t(1134, 'Genera Template')"
                    icon="pi pi-sparkles"
                    class="btn-ai-primary"
                    style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                    [pTooltip]="t(1092, 'Genera template HTML + regole dai dati mock (10-30 sec)')"
                    tooltipPosition="top"
                    [disabled]="!parsedMockData"
                    (click)="analyzeFromMockData()"></button>
          </div>
        </p-card>
      }

      <!-- ===== MODALITÀ: NUOVO DA PDF (newWithPdf) ===== -->
      @if (mode === 'newWithPdf') {
        <p-card [header]="t(1120, 'Carica PDF Esterno')">
          <div class="field">
            <label>{{t(1072, 'Report Code')}}:</label>
            <input type="text"
                   pInputText
                   [(ngModel)]="saveConfig.reportCode"
                   [placeholder]="t(1136, 'es: INV01')"
                   style="width: 300px;">
          </div>

          <div class="field" style="margin-top: 20px;">
            <label>{{t(1085, 'Seleziona File PDF')}}:</label>

            <!-- Area Upload PDF (quando non c'è file) -->
            @if (!uploadedPdf) {
              <div class="pdf-upload-area"
                   [class.drag-over]="isDraggingPdf"
                   (dragover)="onDragOver($event, 'pdf')"
                   (dragleave)="onDragLeave($event, 'pdf')"
                   (drop)="onDrop($event, 'pdf')">
                <div class="drop-zone-content">
                  <i class="pi pi-cloud-upload drop-icon"></i>
                  <p class="drop-text">{{t(1121, 'Trascina qui il PDF')}}</p>
                  <p class="drop-divider">{{t(1102, 'oppure')}}</p>
                  <p-fileUpload
                    mode="basic"
                    accept="application/pdf"
                    [maxFileSize]="10000000"
                    [auto]="true"
                    [chooseLabel]="t(1086, 'Scegli PDF')"
                    chooseIcon="pi pi-upload"
                    (onSelect)="onPdfFileSelected($event)">
                  </p-fileUpload>
                  <p class="upload-hint">
                    <i class="pi pi-info-circle"></i>
                    {{t(1122, 'Formati accettati: PDF (max 10MB)')}}
                  </p>
                </div>
              </div>
            }

            <!-- PDF Caricato (con bottone rimuovi) -->
            @if (uploadedPdf) {
              <div class="uploaded-file-card">
                <div class="file-icon">
                  <i class="pi pi-file-pdf"></i>
                </div>
                <div class="file-info">
                  <span class="file-name">{{uploadedPdf.file.name}}</span>
                  <span class="file-size">({{(uploadedPdf.file.size / 1024).toFixed(0)}} KB)</span>
                </div>
                <button pButton
                        type="button"
                        icon="pi pi-times"
                        [label]="t(1106, 'Rimuovi')"
                        class="p-button-danger p-button-outlined p-button-sm"
                        (click)="removePdf()"></button>
              </div>
            }
          </div>

          <div class="info-box" style="margin-top: 20px;">
            <h5><i class="pi pi-sparkles"></i> {{t(1108, "Cosa farà l'AI")}}:</h5>
            <ul>
              <li><strong>{{t(1123, 'Layout')}}</strong> - {{t(1124, 'Analizza struttura e design del documento')}}</li>
              <li><strong>{{t(1125, 'Mock Data')}}</strong> - {{t(1126, 'Estrae dati di esempio dal contenuto')}}</li>
              <li><strong>{{t(1127, 'Schema')}}</strong> - {{t(1128, 'Inferisce la struttura dati (campi, tipi)')}}</li>
              <li><strong>{{t(1129, 'Regole')}}</strong> - {{t(1130, 'Suggerisce aggregazioni e raggruppamenti')}}</li>
            </ul>
            <p class="time-estimate">
              <i class="pi pi-clock"></i> {{t(1131, 'Tempo stimato: 1-3 minuti')}}
            </p>
          </div>

          <!-- User Instructions for AI -->
          <div class="user-instructions-section">
            <div class="user-instructions-header">
              <h4>
                <i class="pi pi-comment"></i> {{t(1400, 'Istruzioni per Claude AI')}}
              </h4>
              <span class="optional-badge">({{t(1401, 'opzionale')}})</span>
            </div>
            <textarea class="user-instructions-textarea"
                      [(ngModel)]="userInstructions"
                      [placeholder]="t(1402, 'Es: Il totale deve essere in grassetto. Raggruppa per CODICE_CLIENTE. I valori negativi in rosso...')"
                      rows="3"
                      [pTooltip]="t(1403, 'Fornisci indicazioni specifiche per guidare la generazione del template')"
                      tooltipPosition="top">
            </textarea>
            <div class="user-instructions-hint">
              <i class="pi pi-info-circle"></i>
              <span>{{t(1404, 'Descrivi punti critici, campi chiave, logica di raggruppamento o formattazione desiderata')}}</span>
            </div>
          </div>

          <!-- Actions -->
          <div class="card-actions">
            <button pButton
                    type="button"
                    [label]="t(1119, 'Indietro')"
                    icon="pi pi-arrow-left"
                    class="p-button-outlined"
                    style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                    (click)="goBackToModeSelection()"></button>

            <div class="btn-with-bubble">
              <div class="speech-bubble">
                <i class="pi pi-sparkles"></i> {{t(1132, 'Estrai template, dati e regole dal PDF (1-3 min)')}}
              </div>
              <button pButton
                      type="button"
                      [label]="t(1133, 'Analizza PDF')"
                      icon="pi pi-sparkles"
                      class="btn-ai-primary"
                      style="height: 40px; padding: 0 20px; border-radius: 4px; font-weight: 500;"
                      [disabled]="!uploadedPdf"
                      (click)="analyzePdfOnly()"></button>
            </div>
          </div>
        </p-card>
      }

    </div>
    }

    <!-- ========================================== -->
    <!-- STEP 2: ANALYZING -->
    <!-- ========================================== -->
    @if (currentStep === 'analyzing') {
      <div class="step-panel">
        <div class="analyzing-panel">
          <p-progressSpinner></p-progressSpinner>
          <h3>{{t(1025, 'AI sta analizzando il PDF...')}}</h3>
          <p>{{t(1026, 'Attendere, potrebbero volerci alcuni secondi')}}</p>
        </div>
      </div>
    }

    <!-- ========================================== -->
    <!-- STEP 3: PREVIEW & EDIT -->
    <!-- ========================================== -->
    @if (currentStep === 'preview' || currentStep === 'editing') {
    <div class="step-panel">
      
      <!-- Toolbar -->
      <div class="preview-toolbar">
        <div class="toolbar-left">
          <button pButton
                  type="button"
                  [label]="t(1140, 'Aggiorna Preview')"
                  icon="pi pi-refresh"
                  class="p-button-secondary"
                  (click)="updatePreview()"></button>
          <button pButton
                  type="button"
                  [label]="t(1141, 'Formatta HTML')"
                  icon="pi pi-align-left"
                  class="p-button-secondary"
                  (click)="formatTemplateHtml()"></button>
          <!-- Controlli formato PDF inline -->
          <div class="pdf-controls-inline">
            <p-select [options]="[
              {label: 'A4', value: 'A4'},
              {label: 'A3', value: 'A3'},
              {label: 'Letter', value: 'Letter'}
            ]"
            [(ngModel)]="saveConfig.pdfFormat"
            (ngModelChange)="onPdfConfigChange()"
            optionLabel="label"
            optionValue="value"
            [placeholder]="t(1142, 'Formato')"
            [pTooltip]="t(1158, 'Formato carta PDF')"
            tooltipPosition="top"
            [style]="{'min-width': '80px'}">
            </p-select>
            <p-select [options]="[
              {label: t(1205, 'Portrait'), value: 'portrait'},
              {label: t(1206, 'Landscape'), value: 'landscape'}
            ]"
            [(ngModel)]="saveConfig.pdfOrientation"
            (ngModelChange)="onPdfConfigChange()"
            optionLabel="label"
            optionValue="value"
            [placeholder]="t(1143, 'Orientamento')"
            [pTooltip]="t(1159, 'Orientamento PDF')"
            tooltipPosition="top"
            [style]="{'min-width': '110px'}">
            </p-select>
            <div class="page-numbers-checkbox" [pTooltip]="t(1510, 'Mostra numero pagina nel footer del PDF')" tooltipPosition="top">
              <p-checkbox
                [(ngModel)]="saveConfig.showPageNumbers"
                (ngModelChange)="onPdfConfigChange()"
                [binary]="true"
                inputId="showPageNumbers">
              </p-checkbox>
              <label for="showPageNumbers" class="checkbox-label">{{t(1509, 'N° Pagina')}}</label>
            </div>
          </div>
          <button pButton
                  type="button"
                  [label]="t(1144, 'Rigenera PDF')"
                  icon="pi pi-refresh"
                  class="p-button-warning"
                  [disabled]="isAnyEditing"
                  [pTooltip]="t(1145, 'Rigenera il PDF con Puppeteer usando le impostazioni correnti (formato/orientamento)')"
                  tooltipPosition="top"
                  (click)="regeneratePDF()"></button>
          <button pButton
                  type="button"
                  [label]="t(1474, 'Visualizza PDF')"
                  icon="pi pi-eye"
                  class="p-button-info"
                  [disabled]="isAnyEditing"
                  [pTooltip]="t(1475, 'Apre il PDF in un popup con opzione download')"
                  tooltipPosition="top"
                  (click)="downloadPreviewPDF()"></button>
          <!-- Bottone per PDF FastReport (sessione corrente) -->
          @if (fastReportPdf) {
            <button pButton
                    type="button"
                    [label]="t(1149, 'PDF Sorgente')"
                    icon="pi pi-file-pdf"
                    class="p-button-outlined p-button-help"
                    [disabled]="isAnyEditing"
                    [pTooltip]="t(1150, 'Visualizza il PDF originale usato per generare questo template')"
                    tooltipPosition="bottom"
                    (click)="openFastReportPdf()"></button>
          }
          <!-- Bottone per PDF salvato (template esistente in modalità edit) -->
          @if (mode === 'edit' && existingTemplate?.sourcePdf?.base64 && !fastReportPdf) {
            <button pButton
                    type="button"
                    [label]="t(1149, 'PDF Sorgente')"
                    icon="pi pi-file-pdf"
                    class="p-button-outlined p-button-help"
                    [disabled]="isAnyEditing"
                    [pTooltip]="t(1150, 'Visualizza il PDF originale usato per generare questo template')"
                    tooltipPosition="bottom"
                    (click)="openSourcePdf()"></button>
          }
        </div>
        <div class="toolbar-right">
          <button pButton
                  type="button"
                  [label]="quickEditProcessing ? t(1155, 'AI in elaborazione...') : t(1658, 'AI Collaboration')"
                  [icon]="quickEditProcessing ? 'pi pi-spin pi-spinner' : 'pi pi-comments'"
                  class="btn-ai-quickedit"
                  [disabled]="quickEditProcessing || !templateHtml || isAnyEditing"
                  [pTooltip]="t(1659, 'Chat con AI per modificare il template - supporta screenshot')"
                  tooltipPosition="bottom"
                  tooltipStyleClass="ai-tooltip-bubble"
                  (click)="openQuickEditDialog()"></button>
          <button pButton
                  type="button"
                  [label]="styleEnhancing ? t(1155, 'AI in elaborazione...') : t(1156, 'Migliora Stile')"
                  [icon]="styleEnhancing ? 'pi pi-spin pi-spinner' : 'pi pi-sparkles'"
                  class="btn-ai-style"
                  [disabled]="styleEnhancing || isAnyEditing"
                  [pTooltip]="t(1157, 'Richiedi a Claude AI di generare uno stile CSS professionale per il template')"
                  tooltipPosition="bottom"
                  tooltipStyleClass="ai-tooltip-bubble"
                  (click)="openStyleDialog()"></button>
        </div>
      </div>

      <!-- Tabs (PrimeNG 21) -->
      <p-tabs [(value)]="activeTab" (onChange)="onTabChange()">
        <p-tablist>
          <p-tab value="info" [disabled]="isAnyEditing">
            <i class="pi pi-info-circle"></i> {{t(1450, 'Info Template')}}
          </p-tab>
          <p-tab value="template" [disabled]="isAnyEditing && !isEditingHtml">
            <i class="pi pi-code"></i> {{t(1170, 'Template HTML')}}
            @if (isEditingHtml) {<span class="editing-badge">{{t(1174, 'EDITING')}}</span>}
          </p-tab>
          <p-tab value="rules" [disabled]="isAnyEditing && !isEditingRules">
            <i class="pi pi-cog"></i> {{t(1171, 'Aggregation Rules')}}
            @if (isEditingRules) {<span class="editing-badge">{{t(1174, 'EDITING')}}</span>}
          </p-tab>
          <p-tab value="mockData" [disabled]="isAnyEditing && !isEditingMockData">
            <i class="pi pi-database"></i> {{t(1172, 'Mock Data')}}
            @if (isEditingMockData) {<span class="editing-badge">{{t(1174, 'EDITING')}}</span>}
          </p-tab>
          <p-tab value="preview" [disabled]="isAnyEditing">
            <i class="pi pi-eye"></i> {{t(1173, 'Live Preview')}}
          </p-tab>
        </p-tablist>

        <p-tabpanels>
          <!-- TAB: Info Template -->
          <p-tabpanel value="info">
            <div class="tab-edit-toolbar">
              <!-- Bottoni quando NON in editing -->
              @if (!isEditingInfo && mode === 'edit') {
                <button pButton
                        type="button"
                        [label]="t(1540, 'Modifica Info')"
                        icon="pi pi-pencil"
                        class="p-button-warning"
                        [disabled]="isAnyEditing"
                        [pTooltip]="t(1541, 'Entra in modalità modifica per modificare le info')"
                        (click)="startEditingInfo()"></button>
              }
              <!-- Bottoni quando IN editing -->
              @if (isEditingInfo) {
                <div class="edit-actions">
                  <span class="edit-mode-label"><i class="pi pi-exclamation-triangle"></i> {{t(1177, 'Modalità Modifica Attiva')}}</span>
                  <button pButton
                          type="button"
                          [label]="t(1178, 'Salva')"
                          icon="pi pi-check"
                          class="p-button-success"
                          (click)="saveEditingInfo()"></button>
                  <button pButton
                          type="button"
                          [label]="t(1001, 'Annulla')"
                          icon="pi pi-times"
                          class="p-button-secondary"
                          (click)="cancelEditingInfo()"></button>
                </div>
              }
            </div>
            <div class="template-info-panel" [class.editing-active]="isEditingInfo">
              <!-- Riga 1: Identificativi -->
              <div class="info-grid">
                <div class="info-field">
                  <label>{{t(1452, 'Project ID')}}</label>
                  <input pInputText [(ngModel)]="saveConfig.prjId" [disabled]="mode === 'edit'" />
                </div>
                <div class="info-field">
                  <label>{{t(1453, 'Connection')}}</label>
                  <input pInputText [(ngModel)]="saveConfig.connCode" [disabled]="mode === 'edit'" />
                </div>
                <div class="info-field">
                  <label>{{t(1454, 'Report Code')}}</label>
                  <input pInputText [(ngModel)]="saveConfig.reportCode" [disabled]="mode === 'edit'" />
                </div>
                <div class="info-field">
                  <label>{{t(1456, 'Nome Report')}}</label>
                  <input pInputText [(ngModel)]="saveConfig.reportName" [disabled]="mode === 'edit' && !isEditingInfo" />
                </div>
                <div class="info-field">
                  <label>{{t(1457, 'Stato')}}</label>
                  <p-select [options]="statusOptions" [(ngModel)]="saveConfig.status" optionLabel="label" optionValue="value" [style]="{'width': '100%'}" [disabled]="mode === 'edit' && !isEditingInfo"></p-select>
                </div>
              </div>

              <!-- Riga 2: Configurazione PDF -->
              <div class="info-grid-row">
                <div class="info-field">
                  <label>{{t(1461, 'Formato PDF')}}</label>
                  <p-select [options]="pdfFormatOptions" [(ngModel)]="saveConfig.pdfFormat" optionLabel="label" optionValue="value" [style]="{'width': '100%'}" [disabled]="mode === 'edit' && !isEditingInfo"></p-select>
                </div>
                <div class="info-field">
                  <label>{{t(1462, 'Orientamento')}}</label>
                  <p-select [options]="pdfOrientationOptions" [(ngModel)]="saveConfig.pdfOrientation" optionLabel="label" optionValue="value" [style]="{'width': '100%'}" [disabled]="mode === 'edit' && !isEditingInfo"></p-select>
                </div>
              </div>

              <!-- Descrizione -->
              <div class="info-field-wide">
                <label>{{t(1458, 'Descrizione')}}</label>
                <textarea pInputTextarea [(ngModel)]="saveConfig.description" rows="2" autoResize="true" [disabled]="mode === 'edit' && !isEditingInfo"></textarea>
              </div>

              <!-- Istruzioni AI -->
              <div class="info-field-wide ai-instructions">
                <label><i class="pi pi-sparkles"></i> {{t(1400, 'Istruzioni per Claude AI')}} <span class="optional-badge">({{t(1401, 'opzionale')}})</span></label>
                <textarea pInputTextarea
                          [(ngModel)]="userInstructions"
                          rows="3"
                          autoResize="true"
                          [disabled]="mode === 'edit' && !isEditingInfo"
                          [placeholder]="t(1402, 'Es: Il totale deve essere in grassetto. Raggruppa per CODICE_CLIENTE. I valori negativi in rosso...')">
                </textarea>
                <small class="field-hint">
                  <i class="pi pi-info-circle"></i> {{t(1404, 'Descrivi punti critici, campi chiave, logica di raggruppamento o formattazione desiderata')}}
                </small>
              </div>
            </div>
          </p-tabpanel>

          <!-- TAB: HTML Template -->
          <p-tabpanel value="template">
            <div class="tab-edit-toolbar">
              <!-- Bottoni quando NON in editing -->
              @if (!isEditingHtml) {
                <button pButton
                        type="button"
                        [label]="t(1175, 'Modifica HTML')"
                        icon="pi pi-pencil"
                        class="p-button-warning"
                        [disabled]="isAnyEditing"
                        [pTooltip]="t(1176, 'Entra in modalità modifica per modificare HTML')"
                        (click)="startEditingHtml()"></button>
                <button pButton
                        type="button"
                        [label]="t(1511, 'Edit CSS')"
                        icon="pi pi-palette"
                        class="p-button-info"
                        [disabled]="isAnyEditing"
                        [pTooltip]="t(1512, 'Apri editor CSS per modificare gli stili del template')"
                        (click)="openCssEditor()"></button>
              }
              <!-- Bottoni quando IN editing -->
              @if (isEditingHtml) {
                <div class="edit-actions">
                  <span class="edit-mode-label"><i class="pi pi-exclamation-triangle"></i> {{t(1177, 'Modalità Modifica Attiva')}}</span>
                  <button pButton
                          type="button"
                          [label]="t(1178, 'Salva')"
                          icon="pi pi-check"
                          class="p-button-success"
                          (click)="saveEditingHtml()"></button>
                  <button pButton
                          type="button"
                          [label]="t(1001, 'Annulla')"
                          icon="pi pi-times"
                          class="p-button-secondary"
                          (click)="cancelEditingHtml()"></button>
                </div>
              }
            </div>
            <div class="editor-container" [class.editing-active]="isEditingHtml">
              <textarea pTextarea
                        [(ngModel)]="templateHtml"
                        (ngModelChange)="onTemplateChange($event)"
                        rows="20"
                        class="code-editor"
                        [readonly]="!isEditingHtml"></textarea>
            </div>
          </p-tabpanel>

          <!-- TAB: Aggregation Rules -->
          <p-tabpanel value="rules">
            <div class="tab-edit-toolbar">
              <!-- Bottoni quando NON in editing -->
              @if (!isEditingRules) {
                <button pButton
                        type="button"
                        [label]="t(1179, 'Modifica Regole')"
                        icon="pi pi-pencil"
                        class="p-button-warning"
                        [disabled]="isAnyEditing"
                        [pTooltip]="t(1180, 'Entra in modalità modifica per modificare le regole di aggregazione')"
                        (click)="startEditingRules()"></button>
              }
              <!-- Bottoni quando IN editing -->
              @if (isEditingRules) {
                <div class="edit-actions">
                  <span class="edit-mode-label"><i class="pi pi-exclamation-triangle"></i> {{t(1177, 'Modalità Modifica Attiva')}}</span>
                  <button pButton
                          type="button"
                          [label]="t(1178, 'Salva')"
                          icon="pi pi-check"
                          class="p-button-success"
                          (click)="saveEditingRules()"></button>
                  <button pButton
                          type="button"
                          [label]="t(1001, 'Annulla')"
                          icon="pi pi-times"
                          class="p-button-secondary"
                          (click)="cancelEditingRules()"></button>
                </div>
              }
            </div>
            <div class="editor-container" [class.editing-active]="isEditingRules">
              <textarea pTextarea
                        [(ngModel)]="aggregationRulesJson"
                        (ngModelChange)="onRulesChange($event)"
                        rows="20"
                        class="code-editor"
                        [readonly]="!isEditingRules"></textarea>
            </div>
          </p-tabpanel>

          <!-- TAB: Mock Data -->
          <p-tabpanel value="mockData">
            <div class="tab-edit-toolbar">
              <!-- Toggle View Mode (solo quando NON in editing) -->
              @if (!isEditingMockData) {
                <div class="view-mode-toggle">
                  <div class="toggle-button-group">
                    <button pButton type="button"
                            icon="pi pi-table"
                            [class]="mockDataViewMode === 'table' ? 'toggle-btn active' : 'toggle-btn'"
                            [pTooltip]="t(1505, 'Vista Tabella')"
                            (click)="mockDataViewMode = 'table'"></button>
                    <button pButton type="button"
                            icon="pi pi-code"
                            [class]="mockDataViewMode === 'json' ? 'toggle-btn active' : 'toggle-btn'"
                            [pTooltip]="t(1506, 'Vista JSON')"
                            (click)="mockDataViewMode = 'json'"></button>
                  </div>
                  <!-- Expand/Collapse All (solo in vista tabella) -->
                  @if (mockDataViewMode === 'table') {
                    <button pButton type="button" icon="pi pi-plus" class="expand-collapse-btn"
                            [pTooltip]="t(1507, 'Espandi tutto')" (click)="expandAllMockDataNodes()"></button>
                    <button pButton type="button" icon="pi pi-minus" class="expand-collapse-btn"
                            [pTooltip]="t(1508, 'Comprimi tutto')" (click)="collapseAllMockDataNodes()"></button>
                  }
                </div>
                <!-- Bottoni quando NON in editing -->
                <button pButton
                        type="button"
                        [label]="t(1181, 'Modifica Dati')"
                        icon="pi pi-pencil"
                        class="p-button-warning"
                        [disabled]="isAnyEditing"
                        [pTooltip]="t(1182, 'Entra in modalità modifica per modificare i dati mock')"
                        (click)="startEditingMockData()"></button>
              }
              <!-- Bottoni quando IN editing -->
              @if (isEditingMockData) {
                <div class="edit-actions">
                  <span class="edit-mode-label"><i class="pi pi-exclamation-triangle"></i> {{t(1177, 'Modalità Modifica Attiva')}}</span>
                  <button pButton
                          type="button"
                          [label]="t(1178, 'Salva')"
                          icon="pi pi-check"
                          class="p-button-success"
                          (click)="saveEditingMockData()"></button>
                  <button pButton
                          type="button"
                          [label]="t(1001, 'Annulla')"
                          icon="pi pi-times"
                          class="p-button-secondary"
                          (click)="cancelEditingMockData()"></button>
                </div>
              }
            </div>

            <!-- Vista sola lettura - JSON -->
            @if (!isEditingMockData && mockDataViewMode === 'json') {
              <div class="mock-data-viewer">
                <pre>{{aiResult?.mockData || oracleData | json}}</pre>
              </div>
            }

            <!-- Vista sola lettura - TABELLA (Tree View) -->
            @if (!isEditingMockData && mockDataViewMode === 'table' && currentMockData) {
              <div class="mock-data-tree-view">
                <!-- Nodo MAIN -->
                @if (currentMockData.main) {
                  <div class="tree-node">
                    <div class="tree-node-header" (click)="toggleMockDataNode('main')">
                      <i class="pi" [ngClass]="isMockDataNodeExpanded('main') ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                      <i class="pi pi-table node-icon"></i>
                      <span class="node-label">main</span>
                      <span class="node-badge">{{currentMockData.main.length || 0}} {{t(1501, 'record')}}</span>
                    </div>
                    @if (isMockDataNodeExpanded('main') && currentMockData.main.length) {
                      <div class="tree-node-content">
                        <div class="data-table-wrapper">
                          <table class="data-table">
                            <thead>
                              <tr>
                                @for (col of getTableColumns(currentMockData.main); track col) {
                                  <th>{{col}}</th>
                                }
                              </tr>
                            </thead>
                            <tbody>
                              @for (row of currentMockData.main; track $index) {
                                <tr>
                                  @for (col of getTableColumns(currentMockData.main); track col) {
                                    <td><span class="cell-value" [title]="row[col]">{{row[col]}}</span></td>
                                  }
                                </tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Nodo SUBREPORTS -->
                @if (getSubreportKeys().length > 0) {
                  <div class="tree-node">
                    <div class="tree-node-header" (click)="toggleMockDataNode('subreports')">
                      <i class="pi" [ngClass]="isMockDataNodeExpanded('subreports') ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                      <i class="pi pi-folder node-icon"></i>
                      <span class="node-label">subreports</span>
                      <span class="node-badge">{{getSubreportKeys().length}} {{t(1502, 'datasets')}}</span>
                    </div>
                    @if (isMockDataNodeExpanded('subreports')) {
                      <div class="tree-node-content subreports-container">
                        <!-- Singoli subreport -->
                        @for (srKey of getSubreportKeys(); track srKey) {
                          <div class="tree-node subreport-node">
                            <div class="tree-node-header" (click)="toggleMockDataNode('sr_' + srKey)">
                              <i class="pi" [ngClass]="isMockDataNodeExpanded('sr_' + srKey) ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                              <i class="pi pi-list node-icon" [ngClass]="{'empty-icon': !currentMockData.subreports[srKey]?.length}"></i>
                              <span class="node-label">{{srKey}}</span>
                              <span class="node-badge" [ngClass]="{'empty-badge': !currentMockData.subreports[srKey]?.length}">
                                {{currentMockData.subreports[srKey]?.length || 0}} {{t(1501, 'record')}}
                              </span>
                            </div>
                            @if (isMockDataNodeExpanded('sr_' + srKey) && currentMockData.subreports[srKey]?.length) {
                              <div class="tree-node-content">
                                <div class="data-table-wrapper">
                                  <table class="data-table">
                                    <thead>
                                      <tr>
                                        @for (col of getTableColumns(currentMockData.subreports[srKey]); track col) {
                                          <th>{{col}}</th>
                                        }
                                      </tr>
                                    </thead>
                                    <tbody>
                                      @for (row of currentMockData.subreports[srKey]; track $index) {
                                        <tr>
                                          @for (col of getTableColumns(currentMockData.subreports[srKey]); track col) {
                                            <td><span class="cell-value" [title]="row[col]">{{row[col]}}</span></td>
                                          }
                                        </tr>
                                      }
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            }
                            <!-- Messaggio per subreport vuoti -->
                            @if (isMockDataNodeExpanded('sr_' + srKey) && !currentMockData.subreports[srKey]?.length) {
                              <div class="tree-node-content empty-subreport">
                                <i class="pi pi-info-circle"></i> {{t(1503, 'Nessun record in questo subreport')}}
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }

                <!-- Messaggio se non ci sono dati -->
                @if ((!currentMockData.main || !currentMockData.main.length) && !getSubreportKeys().length) {
                  <div class="no-data-message">
                    <i class="pi pi-inbox"></i>
                    <p>{{t(1504, 'Nessun dato disponibile')}}</p>
                  </div>
                }
              </div>
            }

            <!-- Editor quando in editing -->
            @if (isEditingMockData) {
              <div class="editor-container editing-active">
                <textarea pTextarea
                          [(ngModel)]="mockDataJson"
                          rows="20"
                          class="code-editor"></textarea>
              </div>
            }
          </p-tabpanel>

          <!-- TAB: Live Preview -->
          <p-tabpanel value="preview">
            <div class="preview-frame-container">
              <!-- Usa safePreviewHtml per preservare il CSS (Angular sanitizza srcdoc rimuovendo <style>) -->
              <iframe [srcdoc]="safePreviewHtml" class="preview-iframe"></iframe>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>

      <!-- Actions -->
      <div class="step-actions">
        <button pButton
                type="button"
                [label]="t(1119, 'Indietro')"
                icon="pi pi-arrow-left"
                class="p-button-secondary"
                (click)="goBack()"></button>

        <!-- Template Management Buttons (solo se esiste un template salvato) -->
        @if (existingTemplate) {
        <div class="template-management-buttons">
          <button pButton
                  type="button"
                  [label]="t(1212, 'Versioni')"
                  icon="pi pi-history"
                  class="p-button-outlined p-button-info"
                  [disabled]="isAnyEditing"
                  [pTooltip]="t(1213, 'Gestisci storico versioni del template')"
                  tooltipPosition="top"
                  (click)="openVersionsDialog()"></button>
          <button pButton
                  type="button"
                  [label]="t(1218, 'Duplica')"
                  icon="pi pi-copy"
                  class="p-button-outlined p-button-help"
                  [disabled]="isAnyEditing"
                  [pTooltip]="t(1219, 'Duplica template su altra connessione')"
                  tooltipPosition="top"
                  (click)="openDuplicateDialog()"></button>
          <button pButton
                  type="button"
                  [label]="t(1220, 'Pulisci Versioni')"
                  icon="pi pi-trash"
                  class="p-button-outlined p-button-warning"
                  [disabled]="isAnyEditing"
                  [pTooltip]="t(1221, 'Elimina versioni vecchie per risparmiare spazio')"
                  tooltipPosition="top"
                  (click)="openCleanVersionsDialog()"></button>
        </div>
        }

        <button pButton
                type="button"
                [label]="t(1183, 'Salva Template')"
                icon="pi pi-save"
                class="p-button-success p-button-lg"
                [disabled]="isAnyEditing"
                [pTooltip]="t(1184, 'Salva prima le modifiche locali prima di salvare su MongoDB')"
                [tooltipDisabled]="!isAnyEditing"
                tooltipPosition="top"
                (click)="openSaveDialog()"></button>
      </div>

    </div>
    }

  </div>

</div>

<!-- ========================================== -->
<!-- SAVE DIALOG -->
<!-- ========================================== -->
<p-dialog [header]="t(1190, 'Salva Template')"
          [(visible)]="showSaveDialog"
          [modal]="true"
          [style]="{width: '600px'}">

  <div class="p-fluid">

    <div class="field-group">
      <div class="field">
        <label for="prjId">{{t(1207, 'Project ID')}} *</label>
        <input id="prjId"
               type="text"
               pInputText
               [(ngModel)]="saveConfig.prjId"
               [placeholder]="t(1208, 'es: GTSW')"
               required>
      </div>

      <div class="field">
        <label for="connCode">{{t(1209, 'Connection Code')}} *</label>
        <input id="connCode"
               type="text"
               pInputText
               [(ngModel)]="saveConfig.connCode"
               [placeholder]="t(1210, 'es: GTSW_PROD')"
               required>
      </div>
    </div>

    <div class="field">
      <label for="reportCode">{{t(1191, 'Report Code')}}</label>
      <input id="reportCode"
             type="text"
             pInputText
             [(ngModel)]="saveConfig.reportCode"
             [placeholder]="t(1192, 'es: INV01 (auto-generato se vuoto)')">
      <small class="p-text-secondary">
        {{t(1193, 'Lascia vuoto per generare automaticamente: NEWRPT_YYYYMMDDHHMMSS')}}
      </small>
    </div>

    <div class="field">
      <label for="reportName">{{t(1194, 'Report Name')}} *</label>
      <input id="reportName"
             type="text"
             pInputText
             [(ngModel)]="saveConfig.reportName"
             [placeholder]="t(1195, 'es: GTR_FATT_01.fr3')"
             required>
    </div>

    <div class="field">
      <label for="description">{{t(1196, 'Descrizione')}}</label>
      <textarea id="description"
                pTextarea
                [(ngModel)]="saveConfig.description"
                rows="3"
                [placeholder]="t(1197, 'Descrizione breve del template')"></textarea>
    </div>

    <div class="field">
      <label for="notes">{{t(1198, 'Note Sviluppatore')}}</label>
      <textarea id="notes"
                pTextarea
                [(ngModel)]="saveConfig.notes"
                rows="3"
                [placeholder]="t(1199, 'Note tecniche per altri sviluppatori')"></textarea>
    </div>

    <div class="field">
      <label>{{t(1200, 'Status')}}</label>
      <div class="status-radio-group">
        <div class="radio-option" [class.selected]="saveConfig.status === 'draft'" (click)="saveConfig.status = 'draft'">
          <p-radioButton name="status" value="draft" [(ngModel)]="saveConfig.status" inputId="statusDraft"></p-radioButton>
          <label for="statusDraft">{{t(1201, 'Draft')}}</label>
        </div>

        <div class="radio-option" [class.selected]="saveConfig.status === 'active'" (click)="saveConfig.status = 'active'">
          <p-radioButton name="status" value="active" [(ngModel)]="saveConfig.status" inputId="statusActive"></p-radioButton>
          <label for="statusActive">{{t(1202, 'Active')}}</label>
        </div>

        <div class="radio-option" [class.selected]="saveConfig.status === 'archived'" (click)="saveConfig.status = 'archived'">
          <p-radioButton name="status" value="archived" [(ngModel)]="saveConfig.status" inputId="statusArchived"></p-radioButton>
          <label for="statusArchived">{{t(1211, 'Archived')}}</label>
        </div>
      </div>
      <small class="p-text-secondary">
        {{t(1203, 'Draft = Solo testing | Active = Disponibile in produzione | Archived = Non più in uso')}}
      </small>
    </div>

    <div class="field-group">
      <div class="field">
        <label>{{t(1204, 'Formato PDF')}}</label>
        <p-select [options]="[
          {label: 'A4', value: 'A4'},
          {label: 'A3', value: 'A3'},
          {label: 'Letter', value: 'Letter'}
        ]"
        [(ngModel)]="saveConfig.pdfFormat"
        (ngModelChange)="onPdfConfigChange()"
        optionLabel="label"
        optionValue="value">
        </p-select>
      </div>

      <div class="field">
        <label>{{t(1143, 'Orientamento')}}</label>
        <p-select [options]="[
          {label: t(1205, 'Portrait'), value: 'portrait'},
          {label: t(1206, 'Landscape'), value: 'landscape'}
        ]"
        [(ngModel)]="saveConfig.pdfOrientation"
        (ngModelChange)="onPdfConfigChange()"
        optionLabel="label"
        optionValue="value">
        </p-select>
      </div>
    </div>

  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="showSaveDialog = false"></button>
    <button pButton
            type="button"
            [label]="t(1178, 'Salva')"
            icon="pi pi-check"
            class="p-button-success"
            (click)="saveTemplate()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: CARICA TEMPLATE ESISTENTE -->
<!-- ========================================== -->
<p-dialog [header]="t(1230, 'Carica Template Esistente')"
          [(visible)]="showLoadTemplateDialog"
          [modal]="true"
          [style]="{width: '800px', maxHeight: '80vh'}"
          styleClass="load-template-dialog">

  <!-- Filtri -->
  <div class="template-filters">
    <div class="filter-group">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input type="text"
               pInputText
               [(ngModel)]="templateSearchQuery"
               [placeholder]="t(1231, 'Cerca per codice o nome...')"
               (input)="filterTemplates()">
      </span>
    </div>
    <div class="filter-group">
      <p-select [(ngModel)]="templateStatusFilter"
                [options]="templateStatusOptions"
                [placeholder]="t(1232, 'Tutti gli stati')"
                (onChange)="filterTemplates()"
                [showClear]="true">
      </p-select>
    </div>
    <button pButton
            type="button"
            icon="pi pi-refresh"
            class="p-button-secondary p-button-icon-only"
            [pTooltip]="t(1233, 'Ricarica lista')"
            (click)="loadTemplatesList()"></button>
  </div>

  <!-- Loading -->
  @if (loadingTemplates) {
  <div class="templates-loading">
    <p-progressSpinner [style]="{width: '40px', height: '40px'}"></p-progressSpinner>
    <span>{{t(1234, 'Caricamento template...')}}</span>
  </div>
  }

  <!-- Lista Template -->
  @if (!loadingTemplates) {
  <div class="templates-list">
    @for (tpl of filteredTemplatesList; track tpl) {
    <div class="template-item"
         [class.selected]="selectedTemplateToLoad?.prjId === tpl.prjId && selectedTemplateToLoad?.connCode === tpl.connCode && selectedTemplateToLoad?.reportCode === tpl.reportCode"
         (click)="selectTemplateToLoad(tpl)">
      <div class="template-icon">
        <i class="pi pi-file-edit"></i>
      </div>
      <div class="template-info">
        <div class="template-header">
          <span class="template-code">{{tpl.reportCode}}</span>
          <span class="template-status" [class]="'status-' + tpl.status">{{tpl.status}}</span>
        </div>
        <div class="template-name">{{tpl.reportName}}</div>
        <div class="template-meta">
          <span>
            <i class="pi pi-folder"></i> {{tpl.prjId}}
          </span>
          <span>
            <i class="pi pi-database"></i> {{tpl.connCode}}
          </span>
          <span>
            <i class="pi pi-calendar"></i> {{tpl.updatedAt | date:'dd/MM/yyyy HH:mm'}}
          </span>
          <span>
            <i class="pi pi-user"></i> {{tpl.author}}
          </span>
        </div>
      </div>
      <div class="template-actions">
        <i class="pi pi-chevron-right"></i>
      </div>
    </div>
    }

    <!-- Empty State -->
    @if (filteredTemplatesList.length === 0) {
    <div class="templates-empty">
      <i class="pi pi-inbox"></i>
      <p>{{t(1235, 'Nessun template trovato')}}</p>
      @if (templateSearchQuery) {
      <small>{{t(1236, 'Prova con una ricerca diversa')}}</small>
      }
    </div>
    }
  </div>
  }

  <!-- Footer -->
  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="showLoadTemplateDialog = false"></button>
    <button pButton
            type="button"
            [label]="t(1237, 'Carica Template')"
            icon="pi pi-folder-open"
            class="p-button-primary"
            [disabled]="!selectedTemplateToLoad"
            (click)="loadSelectedTemplate()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: AI STYLE ENHANCEMENT -->
<!-- ========================================== -->
<p-dialog [header]="t(1240, 'Migliora Stile con AI')"
          [(visible)]="showStyleDialog"
          [modal]="true"
          [style]="{width: '550px'}"
          styleClass="style-enhancement-dialog">

  <div class="style-dialog-content">
    <!-- Descrizione -->
    <div class="style-intro">
      <i class="pi pi-sparkles"></i>
      <p>{{t(1241, 'Chiedi a Claude AI di generare uno stile CSS professionale per il tuo template.')}}</p>
    </div>

    <!-- Preset Selection -->
    <div class="field">
      <label>{{t(1242, 'Seleziona uno stile')}}:</label>
      <p-select [options]="stylePresets"
                [(ngModel)]="selectedStylePreset"
                [placeholder]="t(1243, 'Scegli uno stile predefinito...')"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
                (onChange)="onStylePresetChange()"
                styleClass="style-preset-dropdown">
      </p-select>
    </div>

    <!-- Custom Request (visible when 'custom' is selected) -->
    @if (selectedStylePreset === 'custom') {
    <div class="field">
      <label>{{t(1244, 'Descrivi lo stile desiderato')}}:</label>
      <textarea pTextarea
                [(ngModel)]="customStyleRequest"
                rows="4"
                [placeholder]="t(1245, 'Es: Stile elegante con colori blu navy, tabelle con bordi sottili, font sans-serif moderno, intestazioni evidenziate...')"
                [style]="{width: '100%'}"></textarea>
    </div>
    }

    <!-- Loading con Timer -->
    @if (styleEnhancing) {
    <div class="style-loading">
      <div class="ai-loader-mini">
        <div class="ai-brain-mini style">
          <i class="pi pi-sparkles"></i>
        </div>
        <div class="ai-pulse-mini style"></div>
      </div>
      <span class="loading-text">{{t(1246, 'Claude sta generando il CSS...')}}</span>
      <div class="elapsed-time-mini">
        <i class="pi pi-clock"></i>
        <span class="time-value">{{styleElapsedTimeFormatted}}</span>
      </div>
      <small class="loading-hint">{{t(1247, 'Generazione stile richiede tipicamente 30-90 secondi')}}</small>
    </div>
    }

    <!-- Timeout Message -->
    @if (styleTimeout && !styleEnhancing) {
    <div class="style-timeout">
      <div class="timeout-header">
        <i class="pi pi-clock"></i>
        <span>{{t(1248, 'Timeout - La richiesta ha impiegato troppo tempo')}}</span>
      </div>
      <p>
        {{t(1249, 'Claude sta impiegando più tempo del previsto per generare lo stile. Questo può accadere quando il template è molto complesso o il server è sotto carico.')}}
      </p>
      <div class="timeout-actions">
        <button pButton
                type="button"
                [label]="t(1250, 'Riprova')"
                icon="pi pi-refresh"
                class="btn-ai-primary"
                (click)="enhanceStyle()"></button>
      </div>
    </div>
    }

    <!-- Result Preview (after generation) -->
    @if (lastStyleResult && !styleEnhancing && !styleTimeout) {
    <div class="style-result">
      <div class="result-header">
        <i class="pi pi-check-circle"></i>
        <span>{{t(1251, 'Stile generato con successo!')}}</span>
      </div>

      <!-- Color Palette Preview -->
      @if (lastStyleResult.colorPalette) {
      <div class="color-palette">
        <label>{{t(1252, 'Palette colori')}}:</label>
        <div class="color-swatches">
          <div class="swatch" [style.background]="lastStyleResult.colorPalette.primary" [pTooltip]="t(1293, 'Primario')"></div>
          <div class="swatch" [style.background]="lastStyleResult.colorPalette.secondary" [pTooltip]="t(1294, 'Secondario')"></div>
          <div class="swatch" [style.background]="lastStyleResult.colorPalette.accent" [pTooltip]="t(1295, 'Accento')"></div>
          <div class="swatch" [style.background]="lastStyleResult.colorPalette.background" [pTooltip]="t(1296, 'Sfondo')"></div>
          <div class="swatch" [style.background]="lastStyleResult.colorPalette.text" [pTooltip]="t(1297, 'Testo')"></div>
        </div>
      </div>
      }

      <!-- Suggestions -->
      @if (lastStyleResult.suggestions && lastStyleResult.suggestions.length > 0) {
      <div class="suggestions">
        <label>{{t(1253, 'Suggerimenti')}}:</label>
        <ul>
          @for (suggestion of lastStyleResult.suggestions; track suggestion) {
          <li>{{suggestion}}</li>
          }
        </ul>
      </div>
      }

      <!-- Action to regenerate -->
      <div class="regenerate-hint">
        <i class="pi pi-info-circle"></i>
        <span>{{t(1254, 'Non soddisfatto? Seleziona un altro stile o modifica la richiesta e clicca "Genera" di nuovo.')}}</span>
      </div>
    </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            [disabled]="styleEnhancing"
            (click)="cancelStyleDialog()"></button>
    <button pButton
            type="button"
            [label]="t(1255, 'Genera Stile')"
            icon="pi pi-sparkles"
            class="btn-ai-primary"
            [disabled]="styleEnhancing || (!selectedStylePreset || (selectedStylePreset === 'custom' && !customStyleRequest))"
            (click)="enhanceStyle()"></button>
    @if (lastStyleResult && !styleEnhancing) {
    <button pButton
            type="button"
            [label]="t(1256, 'Applica e Chiudi')"
            icon="pi pi-check"
            class="p-button-success"
            (click)="applyStyleAndClose()"></button>
    }
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: AI COLLABORATION (ex Quick Edit) -->
<!-- ========================================== -->
<p-dialog [header]="t(1658, 'AI Collaboration')"
          [(visible)]="showQuickEditDialog"
          [modal]="true"
          [style]="{width: '700px', height: '80vh'}"
          styleClass="quick-edit-dialog ai-collaboration-dialog"
          [draggable]="true"
          [resizable]="true">

  <div class="ai-collaboration-content"
       (dragover)="onScreenshotDragOver($event)"
       (dragleave)="onScreenshotDragLeave($event)"
       (drop)="onScreenshotDrop($event)"
       [class.dragging-over]="isDraggingOver">

    <!-- Intro (solo se chat vuota) -->
    @if (chatMessages.length === 0) {
    <div class="quick-edit-intro">
      <i class="pi pi-comments"></i>
      <p>{{t(1650, 'Collabora con Claude AI per modificare il template. Puoi allegare screenshot della preview per mostrare problemi visivi.')}}</p>
      <div class="quick-edit-examples">
        <label>{{t(1272, 'Esempi di richieste')}}:</label>
        <ul>
          <li><code>{{t(1273, 'Metti i totali in colonna invece che tutti al centro')}}</code></li>
          <li><code>{{t(1651, 'Vedi lo screenshot: le righe IVA sono duplicate, dovrebbero essere 3')}}</code></li>
          <li><code>{{t(1275, 'Aggiungi bordi alle celle della tabella')}}</code></li>
        </ul>
      </div>
    </div>
    }

    <!-- Chat Messages -->
    @if (chatMessages.length > 0) {
    <div class="chat-messages-container">
      @for (msg of chatMessages; track msg) {
      <div class="chat-message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'">
        <div class="message-avatar">
          <i class="pi" [ngClass]="msg.role === 'user' ? 'pi-user' : 'pi-bolt'"></i>
        </div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-role">{{msg.role === 'user' ? t(1652, 'Tu') : 'Claude AI'}}</span>
            <span class="message-time">{{msg.timestamp | date:'HH:mm'}}</span>
          </div>
          <div class="message-text">{{msg.content}}</div>

          <!-- Screenshot allegato -->
          @if (msg.screenshot) {
          <div class="message-screenshot">
            <img [src]="'data:image/png;base64,' + msg.screenshot" alt="Screenshot" />
          </div>
          }

          <!-- Modifiche effettuate (solo per AI) -->
          @if (msg.role === 'assistant' && msg.changes && msg.changes.length > 0) {
          <div class="message-changes">
            <label>{{t(1283, 'Modifiche effettuate')}}:</label>
            <ul>
              @for (change of msg.changes; track change) {
              <li>
                <i class="pi pi-check"></i> {{change}}
              </li>
              }
            </ul>
          </div>
          }

          <!-- Suggerimenti (solo per AI) -->
          @if (msg.role === 'assistant' && msg.suggestions && msg.suggestions.length > 0) {
          <div class="message-suggestions">
            <label>{{t(1253, 'Suggerimenti')}}:</label>
            <ul>
              @for (suggestion of msg.suggestions; track suggestion) {
              <li>{{suggestion}}</li>
              }
            </ul>
          </div>
          }
        </div>
      </div>
      }

      <!-- Loading indicator -->
      @if (quickEditProcessing) {
      <div class="chat-message assistant loading">
        <div class="message-avatar">
          <i class="pi pi-bolt"></i>
        </div>
        <div class="message-content">
          <div class="ai-thinking">
            <div class="ai-loader-mini">
              <div class="ai-brain-mini">
                <i class="pi pi-bolt"></i>
              </div>
              <div class="ai-pulse-mini"></div>
            </div>
            <span>{{t(1279, 'Claude sta modificando il template...')}}</span>
            <span class="elapsed-time">{{quickEditElapsedTimeFormatted}}</span>
          </div>
        </div>
      </div>
      }
    </div>
    }

    <!-- Timeout Message -->
    @if (quickEditTimeout && !quickEditProcessing) {
    <div class="quick-edit-timeout">
      <div class="timeout-header">
        <i class="pi pi-clock"></i>
        <span>{{t(1248, 'Timeout - La richiesta ha impiegato troppo tempo')}}</span>
      </div>
      <p>{{t(1281, 'Claude sta impiegando più tempo del previsto. Prova a semplificare la richiesta o riprova.')}}</p>
    </div>
    }

    <!-- Drop zone overlay -->
    @if (isDraggingOver) {
    <div class="drop-overlay">
      <i class="pi pi-image"></i>
      <span>{{t(1653, 'Rilascia l\'immagine qui')}}</span>
    </div>
    }
  </div>

  <!-- Input Area (sempre visibile in basso) -->
  <div class="chat-input-area">
    <!-- Screenshot preview -->
    @if (currentScreenshot) {
    <div class="screenshot-preview">
      <img [src]="'data:image/png;base64,' + currentScreenshot" alt="Screenshot" />
      <button pButton type="button" icon="pi pi-times" class="p-button-rounded p-button-text p-button-danger remove-screenshot" (click)="clearScreenshot()"></button>
      <span class="screenshot-name">{{currentScreenshotName || 'screenshot.png'}}</span>
    </div>
    }

    <!-- Input row -->
    <div class="input-row">
      <!-- Upload button -->
      <button pButton
              type="button"
              icon="pi pi-image"
              class="p-button-text upload-btn"
              [pTooltip]="t(1654, 'Allega screenshot')"
              tooltipPosition="top"
              [disabled]="quickEditProcessing"
              (click)="screenshotInput.click()"></button>
      <input #screenshotInput type="file" accept="image/*" style="display: none" (change)="onFileSelected($event)" />

      <!-- Text input -->
      <textarea pTextarea
                [(ngModel)]="quickEditRequest"
                (input)="onQuickEditRequestChange()"
                (paste)="onPasteImage($event)"
                (keydown.control.enter)="executeQuickEdit()"
                rows="2"
                [placeholder]="t(1655, 'Descrivi la modifica... (Ctrl+V per incollare screenshot)')"
                [disabled]="quickEditProcessing"
                class="chat-input"></textarea>

      <!-- Send button -->
      <button pButton
              type="button"
              icon="pi pi-send"
              class="btn-ai-primary send-btn"
              [disabled]="quickEditProcessing || !quickEditRequest.trim()"
              (click)="executeQuickEdit()"></button>
    </div>

    <small class="input-hint">{{t(1656, 'Ctrl+Invio per inviare • Trascina o incolla screenshot')}}</small>
  </div>

  <ng-template pTemplate="footer">
    <div class="footer-left">
      <button pButton
              type="button"
              [label]="t(1657, 'Nuova Chat')"
              icon="pi pi-refresh"
              class="p-button-secondary"
              [disabled]="quickEditProcessing || chatMessages.length === 0"
              (click)="chatMessages = []; clearScreenshot()"></button>
    </div>
    <div class="footer-right">
      <button pButton
              type="button"
              [label]="t(1285, 'Chiudi')"
              icon="pi pi-times"
              class="p-button-secondary"
              [disabled]="quickEditProcessing"
              (click)="cancelQuickEditDialog()"></button>
    </div>
  </ng-template>

</p-dialog>

<!-- Confirm Exit Dialog -->
<p-dialog [header]="t(1352, 'Conferma Uscita')"
          [(visible)]="showConfirmExitDialog"
          [modal]="true"
          [closable]="true"
          [style]="{width: '400px'}"
          styleClass="confirm-exit-dialog">

  <div class="confirm-exit-content">
    <i class="pi pi-exclamation-triangle confirm-exit-icon"></i>
    <p class="confirm-exit-message">{{t(1351, 'Ci sono modifiche non salvate. Sicuro di voler uscire? Le modifiche andranno perse.')}}</p>
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1353, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="showConfirmExitDialog = false"></button>
    <button pButton
            type="button"
            [label]="t(1354, 'Esci senza salvare')"
            icon="pi pi-sign-out"
            class="p-button-danger"
            (click)="confirmExit()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: CONFERMA RIGENERAZIONE TEMPLATE -->
<!-- ========================================== -->
<p-dialog [header]="t(1480, 'Conferma Rigenerazione')"
          [(visible)]="showConfirmRegenerateDialog"
          [modal]="true"
          [closable]="true"
          [style]="{width: '650px'}"
          styleClass="confirm-regenerate-dialog">

  <div class="confirm-regenerate-content">
    <div class="regenerate-warning-section">
      <i class="pi pi-exclamation-triangle confirm-regenerate-icon"></i>
      <div>
        <p class="confirm-regenerate-message">{{t(1481, 'Sei sicuro di voler rigenerare il template?')}}</p>
        <p class="confirm-regenerate-warning">{{t(1482, 'Questa operazione sovrascriverà completamente il template HTML e le regole di aggregazione attuali con una nuova generazione AI.')}}</p>
      </div>
    </div>

    <!-- Campo istruzioni per AI -->
    <div class="regenerate-prompt-section">
      <label>{{t(1484, 'Istruzioni per AI (opzionale)')}}:</label>
      <textarea pTextarea
                [(ngModel)]="regeneratePrompt"
                rows="5"
                [placeholder]="t(1485, 'Es: Genera una fattura professionale con logo in alto a sinistra, dati cliente a destra. Usa tabelle con bordi per i dettagli. Le note vanno in fondo...')"
                [style]="{width: '100%'}"></textarea>
      <small class="regenerate-prompt-hint">{{t(1486, 'Queste istruzioni guideranno Claude AI nella generazione del nuovo template')}}</small>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="cancelRegenerateTemplate()"></button>
    <button pButton
            type="button"
            [label]="t(1483, 'Sì, Rigenera')"
            icon="pi pi-sync"
            class="p-button-warning"
            (click)="confirmRegenerateTemplate()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: PDF VIEWER POPUP -->
<!-- ========================================== -->
<p-dialog [header]="t(1470, 'Anteprima PDF')"
          [(visible)]="showPdfViewerDialog"
          [modal]="true"
          [style]="{width: '90vw', height: '90vh'}"
          [maximizable]="true"
          [draggable]="false"
          [resizable]="false"
          styleClass="pdf-viewer-dialog"
          (onHide)="closePdfViewer()">

  <div class="pdf-viewer-content">
    <!-- Loading -->
    @if (pdfViewerLoading) {
    <div class="pdf-viewer-loading">
      <p-progressSpinner [style]="{width: '50px', height: '50px'}"></p-progressSpinner>
      <span>{{t(1471, 'Caricamento PDF...')}}</span>
    </div>
    }

    <!-- PDF Iframe -->
    @if (pdfViewerUrl && !pdfViewerLoading) {
    <iframe [src]="pdfViewerUrl"
            class="pdf-viewer-iframe"
            type="application/pdf">
    </iframe>
    }

    <!-- Fallback message -->
    @if (!pdfViewerUrl && !pdfViewerLoading) {
    <div class="pdf-viewer-fallback">
      <i class="pi pi-file-pdf"></i>
      <p>{{t(1472, 'Nessun PDF da visualizzare')}}</p>
    </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <div class="pdf-viewer-footer">
      @if (pdfViewerFileName) {
      <span class="pdf-filename">
        <i class="pi pi-file-pdf"></i> {{pdfViewerFileName}}
      </span>
      }
      <div class="pdf-viewer-actions">
        <button pButton
                type="button"
                [label]="t(1473, 'Download')"
                icon="pi pi-download"
                class="p-button-success"
                [disabled]="!pdfViewerBlob"
                (click)="downloadPdfFromViewer()"></button>
        <button pButton
                type="button"
                [label]="t(1285, 'Chiudi')"
                icon="pi pi-times"
                class="p-button-secondary"
                (click)="closePdfViewer()"></button>
      </div>
    </div>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: DUPLICA TEMPLATE -->
<!-- ========================================== -->
<p-dialog [header]="t(1410, 'Duplica Template')"
          [(visible)]="showDuplicateDialog"
          [modal]="true"
          [style]="{width: '500px'}"
          styleClass="duplicate-template-dialog">

  <div class="duplicate-dialog-content">
    <!-- Info Template Sorgente -->
    <div class="duplicate-source-info">
      <i class="pi pi-copy"></i>
      <p>{{t(1411, 'Duplica il template corrente su un\'altra connessione dello stesso progetto.')}}</p>
    </div>

    <!-- Info sul template sorgente -->
    @if (existingTemplate) {
    <div class="field">
      <label>{{t(1412, 'Template sorgente')}}:</label>
      <div class="source-template-box">
        <span class="template-key">
          <strong>{{existingTemplate.prjId}}</strong> /
          <strong>{{existingTemplate.connCode}}</strong> /
          <strong>{{existingTemplate.reportCode}}</strong>
        </span>
        <span class="template-name">{{existingTemplate.reportName}}</span>
      </div>
    </div>
    }

    <!-- Selezione connessione di destinazione -->
    <div class="field">
      <label for="targetConnCode">{{t(1413, 'Connessione destinazione')}} *</label>
      <p-select [options]="availableConnectionsFiltered"
                [(ngModel)]="duplicateTargetConnCode"
                [placeholder]="t(1414, 'Seleziona connessione...')"
                optionLabel="label"
                optionValue="value"
                appendTo="body"
                [style]="{width: '100%'}"
                [disabled]="duplicateProcessing">
      </p-select>
      <small class="p-text-secondary">
        {{t(1415, 'Il template sarà copiato con status "draft" e senza storico versioni')}}
      </small>
    </div>

    <!-- Warning se la connessione è la stessa -->
    @if (duplicateTargetConnCode === existingTemplate?.connCode) {
    <div class="duplicate-warning">
      <i class="pi pi-exclamation-triangle"></i>
      <span>{{t(1416, 'La connessione di destinazione deve essere diversa da quella sorgente')}}</span>
    </div>
    }

    <!-- Loading -->
    @if (duplicateProcessing) {
    <div class="duplicate-loading">
      <p-progressSpinner [style]="{width: '30px', height: '30px'}"></p-progressSpinner>
      <span>{{t(1417, 'Duplicazione in corso...')}}</span>
    </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            [disabled]="duplicateProcessing"
            (click)="cancelDuplicateDialog()"></button>
    <button pButton
            type="button"
            [label]="t(1418, 'Duplica')"
            icon="pi pi-copy"
            class="p-button-help"
            [disabled]="duplicateProcessing || !duplicateTargetConnCode"
            (click)="duplicateTemplate()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: PULISCI VERSIONI -->
<!-- ========================================== -->
<p-dialog [header]="t(1220, 'Pulisci Versioni')"
          [(visible)]="showCleanVersionsDialog"
          [modal]="true"
          [style]="{width: '500px'}"
          styleClass="clean-versions-dialog">

  <div class="clean-versions-content">
    <!-- Info -->
    <div class="clean-versions-info">
      <i class="pi pi-trash"></i>
      <p>{{t(1435, 'Elimina le versioni più vecchie per risparmiare spazio nel database.')}}</p>
    </div>

    <!-- Stats attuali -->
    <div class="versions-stats">
      <div class="stat-item">
        <span class="stat-label">{{t(1436, 'Versioni attuali')}}:</span>
        <span class="stat-value">{{totalVersionsCount}}</span>
      </div>
    </div>

    <!-- Selezione quante mantenere -->
    <div class="field">
      <label for="keepLastVersions">{{t(1437, 'Versioni da mantenere')}} *</label>
      <p-select [options]="keepLastOptions"
                [(ngModel)]="keepLastVersions"
                optionLabel="label"
                optionValue="value"
                [style]="{width: '100%'}"
                [disabled]="cleanVersionsProcessing">
      </p-select>
      <small class="p-text-secondary">
        {{t(1438, 'Le versioni più recenti saranno conservate')}}
      </small>
    </div>

    <!-- Preview eliminazione -->
    <div class="delete-preview" [class.warning]="versionsToDeleteCount > 0" [class.safe]="versionsToDeleteCount === 0">
      <i class="pi" [class.pi-exclamation-triangle]="versionsToDeleteCount > 0" [class.pi-check-circle]="versionsToDeleteCount === 0"></i>
      <div class="preview-text">
        @if (versionsToDeleteCount > 0) {
        <span>
          {{t(1439, 'Saranno eliminate')}} <strong>{{versionsToDeleteCount}}</strong> {{t(1440, 'versioni')}}
        </span>
        }
        @if (versionsToDeleteCount === 0) {
        <span>
          {{t(1441, 'Nessuna versione sarà eliminata')}}
        </span>
        }
      </div>
    </div>

    <!-- Warning -->
    @if (versionsToDeleteCount > 0) {
    <div class="clean-warning">
      <i class="pi pi-info-circle"></i>
      <span>{{t(1442, 'Questa operazione è irreversibile. Le versioni eliminate non potranno essere recuperate.')}}</span>
    </div>
    }

    <!-- Loading -->
    @if (cleanVersionsProcessing) {
    <div class="clean-loading">
      <p-progressSpinner [style]="{width: '30px', height: '30px'}"></p-progressSpinner>
      <span>{{t(1443, 'Pulizia in corso...')}}</span>
    </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            [disabled]="cleanVersionsProcessing"
            (click)="cancelCleanVersionsDialog()"></button>
    <button pButton
            type="button"
            [label]="t(1444, 'Pulisci')"
            icon="pi pi-trash"
            class="p-button-warning"
            [disabled]="cleanVersionsProcessing || versionsToDeleteCount === 0"
            (click)="cleanOldVersions()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: STORICO VERSIONI -->
<!-- ========================================== -->
<p-dialog [header]="t(1520, 'Storico Versioni')"
          [(visible)]="showVersionsDialog"
          [modal]="true"
          [style]="{width: '800px', maxHeight: '80vh'}"
          styleClass="versions-history-dialog"
          (onHide)="closeVersionsDialog()">

  <div class="versions-dialog-content">
    <!-- Info versione attuale -->
    @if (existingTemplate) {
    <div class="current-version-info">
      <i class="pi pi-info-circle"></i>
      <span>{{t(1521, 'Versione attuale')}}: <strong>v{{existingTemplate.version}}</strong></span>
    </div>
    }

    <!-- Tabella versioni -->
    <div class="versions-table-container">
      <table class="versions-table">
        <thead>
          <tr>
            <th class="col-version">{{t(1522, 'Versione')}}</th>
            <th class="col-date">{{t(1523, 'Data')}}</th>
            <th class="col-author">{{t(1524, 'Autore')}}</th>
            <th class="col-actions">{{t(1525, 'Azioni')}}</th>
          </tr>
        </thead>
        <tbody>
          @for (version of sortedVersions; track version) {
          <tr [class.current-version]="version.version === existingTemplate?.version">
            <td class="col-version">
              <span class="version-number">v{{version.version}}</span>
              @if (version.version === existingTemplate?.version) {
              <span class="current-badge">
                {{t(1526, 'attuale')}}
              </span>
              }
            </td>
            <td class="col-date">{{formatVersionDate(version.savedAt || version.createdAt)}}</td>
            <td class="col-author">{{version.savedBy || version.createdBy || '-'}}</td>
            <td class="col-actions">
              <div class="action-buttons">
                <button pButton
                        type="button"
                        class="version-action-btn version-preview-btn"
                        [pTooltip]="t(1527, 'Anteprima')"
                        tooltipPosition="top"
                        (click)="previewVersion(version)">
                  <i class="pi pi-eye"></i>
                </button>
                <button pButton
                        type="button"
                        class="version-action-btn version-restore-btn"
                        [pTooltip]="t(1528, 'Ripristina')"
                        tooltipPosition="top"
                        (click)="confirmRestoreVersion(version)">
                  <i class="pi pi-replay"></i>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>

      <!-- Empty state -->
      @if (sortedVersions.length === 0) {
      <div class="versions-empty">
        <i class="pi pi-inbox"></i>
        <p>{{t(1529, 'Nessuna versione precedente disponibile')}}</p>
      </div>
      }
    </div>

  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1285, 'Chiudi')"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="closeVersionsDialog()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: CONFERMA RIPRISTINO VERSIONE -->
<!-- ========================================== -->
<p-dialog [header]="t(1531, 'Conferma Ripristino')"
          [(visible)]="showRestoreConfirmDialog"
          [modal]="true"
          [closable]="!restoringVersion"
          [style]="{width: '450px'}"
          styleClass="restore-confirm-dialog">

  <div class="restore-confirm-content">
    <i class="pi pi-exclamation-triangle restore-confirm-icon"></i>
    <p class="restore-confirm-message">
      {{t(1532, 'Sei sicuro di voler ripristinare la versione')}}
      <strong>v{{selectedVersionForRestore?.version}}</strong>?
    </p>
    <p class="restore-confirm-warning">
      {{t(1533, 'La versione corrente verrà salvata nello storico prima del ripristino.')}}
    </p>

    <!-- Loading -->
    @if (restoringVersion) {
    <div class="restore-loading">
      <p-progressSpinner [style]="{width: '30px', height: '30px'}"></p-progressSpinner>
      <span>{{t(1534, 'Ripristino in corso...')}}</span>
    </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1001, 'Annulla')"
            icon="pi pi-times"
            class="p-button-secondary"
            [disabled]="restoringVersion"
            (click)="cancelRestoreVersion()"></button>
    <button pButton
            type="button"
            [label]="t(1535, 'Ripristina')"
            icon="pi pi-replay"
            class="p-button-warning"
            [disabled]="restoringVersion"
            (click)="restoreVersion()"></button>
  </ng-template>

</p-dialog>

<!-- ========================================== -->
<!-- DIALOG: PREVIEW VERSIONE HTML -->
<!-- ========================================== -->
<p-dialog [header]="t(1530, 'Anteprima versione') + ' v' + (selectedVersionForPreview?.version || '')"
          [(visible)]="showVersionPreviewDialog"
          [modal]="true"
          [style]="{width: '90vw', height: '85vh'}"
          [maximizable]="true"
          [draggable]="false"
          [resizable]="false"
          styleClass="version-preview-dialog"
          (onHide)="closeVersionPreview()">

  <div class="version-preview-dialog-content">
    <iframe [srcdoc]="safeVersionPreviewHtml" class="version-preview-full-iframe"></iframe>
  </div>

  <ng-template pTemplate="footer">
    <button pButton
            type="button"
            [label]="t(1285, 'Chiudi')"
            icon="pi pi-times"
            class="p-button-secondary"
            (click)="closeVersionPreview()"></button>
  </ng-template>

</p-dialog>

<!-- ==================== CSS EDITOR DIALOG ==================== -->
<p-dialog [header]="t(1513, 'Editor CSS')"
          [(visible)]="showCssEditorDialog"
          [modal]="true"
          [closable]="true"
          [draggable]="true"
          [resizable]="true"
          [style]="{width: '80vw', height: '80vh'}"
          [contentStyle]="{'overflow': 'hidden', 'display': 'flex', 'flex-direction': 'column'}"
          styleClass="css-editor-dialog">

  <div class="css-editor-container">
    <div class="css-editor-info">
      <i class="pi pi-info-circle"></i>
      <span>{{t(1514, 'Modifica il CSS del template. Le modifiche verranno applicate al tag &lt;style&gt; nel template HTML.')}}</span>
    </div>
    <textarea pTextarea
              [(ngModel)]="cssEditorContent"
              class="css-code-editor"
              [placeholder]="t(1515, 'Inserisci qui il CSS...')"></textarea>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer-buttons">
      <button pButton
              type="button"
              [label]="t(1516, 'Formatta CSS')"
              icon="pi pi-align-left"
              class="p-button-secondary"
              (click)="formatCssInEditor()"></button>
      <button pButton
              type="button"
              [label]="t(1001, 'Annulla')"
              icon="pi pi-times"
              class="p-button-secondary"
              (click)="closeCssEditor()"></button>
      <button pButton
              type="button"
              [label]="t(1517, 'Applica CSS')"
              icon="pi pi-check"
              class="p-button-success"
              (click)="applyCssFromEditor()"></button>
    </div>
  </ng-template>

</p-dialog>
