<div class="pageFormat">
  <app-gts-loader></app-gts-loader>

  <!-- PrimeNG Toast for notifications -->
  <p-toast></p-toast>

  <!-- Confirm Dialog -->
  <p-dialog
    [(visible)]="showConfirmDialog"
    [header]="confirmDialogHeader"
    [modal]="true"
    [closable]="true"
    [style]="{ width: '400px' }"
    [draggable]="false"
    [resizable]="false"
    appendTo="body"
    [baseZIndex]="10000">
    <p class="confirm-message">{{ confirmDialogMessage }}</p>
    <div class="confirm-dialog-footer">
      <button
        pButton
        type="button"
        class="p-button-secondary"
        [label]="confirmDialogRejectLabel"
        icon="pi pi-times"
        (click)="onConfirmReject()">
      </button>
      <button
        pButton
        type="button"
        class="p-button-danger"
        [label]="confirmDialogAcceptLabel"
        icon="pi pi-check"
        (click)="onConfirmAccept()">
      </button>
    </div>
  </p-dialog>

  <!-- Hidden file input for LOAD_EXCEL custom code -->
  <input type="file"
         #excelFileInput
         accept=".xlsx,.xls"
         style="display: none"
         (change)="onExcelFileSelected($event)">

  <app-gts-toolbar
    [prjId]="prjId"
    [formId]="formId"
    [objectName]="'mainToolbar'"
    [customData]="customData"
    (newValueEvent)="gtsDataService.toolbarSelectEvent($event)"
  ></app-gts-toolbar>

  <!-- STANDARD GTS PAGE CONTENT -->
  @if (!showDashboard) {
    <div [style]="viewStyle">
      @for (element of metaData.tabs; track element) {
        @if (element.visible) {
          <app-gts-tabs
            [style]="'grid-area: '+element.gridArea"
            [prjId]="prjId"
            [formId]="formId"
            [objectName]="element.objectName"
          ></app-gts-tabs>
        }
      }

      @for (element of metaData.toolbars; track element) {
        @if (element.visible && element.objectName != 'mainToolbar' && !element.toolbarFlagSubmit) {
          <app-gts-toolbar
            [style]="'grid-area: '+element.gridArea"
            [prjId]="prjId"
            [formId]="formId"
            [objectName]="element.objectName"
            [customCssClass]="element.customCssClass"
            (newValueEvent)="gtsDataService.toolbarSelectEvent($event)"
          ></app-gts-toolbar>
        }
      }

      @for (element of metaData.grids; track element) {
        @if (element.visible) {
          <app-gts-grid
            [style]="'grid-area: '+element.gridArea"
            [prjId]="prjId"
            [formId]="formId"
            [objectName]="element.objectName"
          ></app-gts-grid>
        }
      }

      @for (element of metaData.forms; track element) {
        @if (element.visible && !element.groupShowPopUp) {
          <app-gts-form
            [style]="'grid-area: '+element.gridArea"
            [prjId]="prjId"
            [formId]="formId"
            [objectName]="element.objectName"
          ></app-gts-form>
        }
        @if (element.visible && element.groupShowPopUp) {
          <app-gts-form-popup
            [prjId]="prjId"
            [formId]="formId"
            [objectName]="element.objectName"
          ></app-gts-form-popup>
        }
      }
    </div>
  }

  <!-- DASHBOARD VIEW -->
  @if (showDashboard) {
    <div class="sales-dashboard">

      <!-- DASHBOARD HEADER -->
      <div class="dashboard-header">
        <div class="header-left">
          <h1>{{ t(1531, 'Dashboard Vendite') }}</h1>
          @if (dashboardData) {
            <p class="period">
              {{ t(1532, 'Periodo') }}: {{ dashboardData.metadata.period_start | date:'dd/MM/yyyy' }} -
              {{ dashboardData.metadata.period_end | date:'dd/MM/yyyy' }}
            </p>
          }
        </div>
        <div class="header-right">
          <!-- Toggle Dashboard Mode Button -->
          <p-button
            [icon]="showGtsDashboard ? 'pi pi-th-large' : 'pi pi-database'"
            [label]="showGtsDashboard ? 'Classic View' : 'Metadata View'"
            styleClass="p-button-outlined"
            (onClick)="toggleDashboardMode()"
            [pTooltip]="showGtsDashboard ? t(1604, 'Passa alla dashboard classica') : t(1605, 'Passa alla dashboard da metadati')"
            tooltipPosition="bottom"
            [style]="{'margin-right': '0.5rem'}">
          </p-button>

          <!-- AI Analyzer Button -->
          <p-button
            icon="pi pi-sparkles"
            label="AI Analyzer"
            styleClass="ai-analyzer-btn"
            (onClick)="gtsAiAnalyzerData = rawExcelData; showGtsAiAnalyzer = true"
            [pTooltip]="t(1533, 'Analizza i dati con l\'intelligenza artificiale')"
            tooltipPosition="bottom"
            tooltipStyleClass="gts-tooltip"
            [style]="{'margin-right': '1rem'}">
          </p-button>

          <p-select
            [(ngModel)]="selectedYear"
            [options]="yearOptions"
            optionLabel="label"
            optionValue="value"
            (onChange)="onYearChange()"
            [style]="{'width': '180px'}">
          </p-select>

          @if (showAdvancedFilters) {
            <p-select
              [(ngModel)]="selectedQuarter"
              [options]="quarterOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onQuarterChange()"
              [style]="{'width': '160px'}">
            </p-select>

            <p-select
              [(ngModel)]="selectedMonth"
              [options]="monthOptions"
              optionLabel="label"
              optionValue="value"
              (onChange)="onMonthChange()"
              [style]="{'width': '150px'}">
            </p-select>
          }
        </div>
      </div>

      <!-- GTS DASHBOARD (Metadata-driven) -->
      @if (showGtsDashboard) {
        <app-gts-dashboard
          [config]="gtsDashboardConfig"
          [rawData]="rawExcelData"
          [visible]="true"
          (onRefresh)="onGtsDashboardRefresh()"
          (onDataRequest)="onDashboardDataRequest($event)">
        </app-gts-dashboard>
      }

      <!-- CLASSIC DASHBOARD LOADING -->
      @if (!showGtsDashboard && dashboardLoading) {
        <div class="loading-container">
          <i class="pi pi-spin pi-spinner" style="font-size: 3rem;"></i>
          <p>{{ t(1534, 'Caricamento dashboard...') }}</p>
        </div>
      }

      <!-- CLASSIC DASHBOARD CONTENT -->
      @if (!showGtsDashboard && !dashboardLoading && dashboardData) {

        <!-- KPI CARDS -->
        <div class="kpi-grid" *ngIf="kpi">

          <p-card class="kpi-card kpi-primary">
            <div class="kpi-content">
              <div class="kpi-icon">üí∞</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1535, 'Fatturato Totale') }}</div>
                <div class="kpi-value">{{ formatCurrency(kpi.totale_fatturato) }}</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-success">
            <div class="kpi-content">
              <div class="kpi-icon">üíµ</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1536, 'Margine Totale') }}</div>
                <div class="kpi-value">{{ formatCurrency(kpi.margine_totale) }}</div>
                <div class="kpi-sub">{{ formatPercent(kpi.margine_percentuale) }}</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-info">
            <div class="kpi-content">
              <div class="kpi-icon">üì¶</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1537, 'Quantit√† Totale') }}</div>
                <div class="kpi-value">{{ formatNumber(kpi.totale_kg, 0) }} kg</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-warning">
            <div class="kpi-content">
              <div class="kpi-icon">üìÑ</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1538, 'Ordini') }}</div>
                <div class="kpi-value">{{ formatNumber(kpi.num_ordini, 0) }}</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-purple">
            <div class="kpi-content">
              <div class="kpi-icon">üë•</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1539, 'Clienti') }}</div>
                <div class="kpi-value">{{ formatNumber(kpi.num_clienti, 0) }}</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-teal">
            <div class="kpi-content">
              <div class="kpi-icon">üè∑Ô∏è</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1540, 'Prodotti') }}</div>
                <div class="kpi-value">{{ formatNumber(kpi.num_prodotti, 0) }}</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-indigo">
            <div class="kpi-content">
              <div class="kpi-icon">‚öñÔ∏è</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1541, 'Prezzo Medio/kg') }}</div>
                <div class="kpi-value">{{ formatCurrency(kpi.prezzo_medio_kg) }}</div>
              </div>
            </div>
          </p-card>

          <p-card class="kpi-card kpi-danger">
            <div class="kpi-content">
              <div class="kpi-icon">üí∏</div>
              <div class="kpi-details">
                <div class="kpi-label">{{ t(1542, 'Costi Totali') }}</div>
                <div class="kpi-value">{{ formatCurrency(kpi.totale_costi) }}</div>
              </div>
            </div>
          </p-card>

        </div>

        <!-- CHARTS ROW 1: TREND -->
        <div class="charts-row">

          <p-card [header]="t(1551, 'Trend Fatturato e Margine')" class="chart-card chart-large chart-trend">
            <div class="chart-container" style="height: 350px;">
              @if (trendFatturatoChart) {
                <p-chart type="line"
                         [data]="trendFatturatoChart"
                         [options]="lineChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}">
                </p-chart>
              }
            </div>
          </p-card>

          <p-card [header]="t(1552, 'Trend Margine %')" class="chart-card chart-medium chart-trend">
            <div class="chart-container" style="height: 350px;">
              @if (trendMargineChart) {
                <p-chart type="line"
                         [data]="trendMargineChart"
                         [options]="lineChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}">
                </p-chart>
              }
            </div>
          </p-card>

        </div>

        <!-- CHARTS ROW 2: TOP CLIENTI E PRODOTTI -->
        <div class="charts-row">

          <!-- TOP CLIENTI con drill-down -->
          <p-card class="chart-card chart-medium chart-clienti">
            <ng-template pTemplate="header">
              <div class="chart-header-with-back">
                @if (clientiDrillDown.active) {
                  <p-button
                    icon="pi pi-arrow-left"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    (onClick)="backFromClientiDrillDown()"
                    [pTooltip]="t(1680, 'Indietro')">
                  </p-button>
                  <span class="chart-title">{{ t(1681, 'Prodotti per') }}: {{ clientiDrillDown.clienteName }}</span>
                } @else {
                  <span class="chart-title">{{ t(1553, 'Top 10 Clienti') }}</span>
                  <span class="chart-hint">{{ t(1682, 'Click per dettaglio') }}</span>
                }
              </div>
            </ng-template>
            <div class="chart-container" style="height: 500px;">
              @if (clientiDrillDown.active && clientiDrillDown.chart) {
                <p-chart type="pie"
                         [data]="clientiDrillDown.chart"
                         [options]="pieChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}">
                </p-chart>
              } @else if (topClientiChart) {
                <p-chart type="bar"
                         [data]="topClientiChart"
                         [options]="barChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}"
                         (onDataSelect)="onClienteClick($event)">
                </p-chart>
              }
            </div>
          </p-card>

          <!-- TOP PRODOTTI con drill-down -->
          <p-card class="chart-card chart-medium chart-prodotti">
            <ng-template pTemplate="header">
              <div class="chart-header-with-back">
                @if (prodottiDrillDown.active) {
                  <p-button
                    icon="pi pi-arrow-left"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    (onClick)="backFromProdottiDrillDown()"
                    [pTooltip]="t(1680, 'Indietro')">
                  </p-button>
                  <span class="chart-title">{{ t(1683, 'Clienti per') }}: {{ prodottiDrillDown.prodottoName }}</span>
                } @else {
                  <span class="chart-title">{{ t(1554, 'Top 10 Prodotti') }}</span>
                  <span class="chart-hint">{{ t(1682, 'Click per dettaglio') }}</span>
                }
              </div>
            </ng-template>
            <div class="chart-container" style="height: 500px;">
              @if (prodottiDrillDown.active && prodottiDrillDown.chart) {
                <p-chart type="pie"
                         [data]="prodottiDrillDown.chart"
                         [options]="pieChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}">
                </p-chart>
              } @else if (topProdottiChart) {
                <p-chart type="bar"
                         [data]="topProdottiChart"
                         [options]="barChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}"
                         (onDataSelect)="onProdottoClick($event)">
                </p-chart>
              }
            </div>
          </p-card>

        </div>

        <!-- CHARTS ROW 3: CATEGORIE E FAMIGLIE -->
        <div class="charts-row">

          <!-- CATEGORIE con drill-down -->
          <p-card class="chart-card chart-medium chart-categoria">
            <ng-template pTemplate="header">
              <div class="chart-header-with-back">
                @if (categoriaDrillDown.active) {
                  <p-button
                    icon="pi pi-arrow-left"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    (onClick)="backFromCategoriaDrillDown()"
                    [pTooltip]="t(1680, 'Indietro')">
                  </p-button>
                  <span class="chart-title">{{ t(1683, 'Clienti per') }}: {{ categoriaDrillDown.categoriaName }}</span>
                } @else {
                  <span class="chart-title">{{ t(1555, 'Fatturato per Categoria') }}</span>
                  <span class="chart-hint">{{ t(1682, 'Click per dettaglio') }}</span>
                }
              </div>
            </ng-template>
            <div class="chart-container" [style.height]="categoriaDrillDown.active ? '450px' : '350px'">
              @if (categoriaDrillDown.active && categoriaDrillDown.chart) {
                <p-chart type="bar"
                         [data]="categoriaDrillDown.chart"
                         [options]="barChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}">
                </p-chart>
              } @else if (perCategoriaChart) {
                <p-chart type="pie"
                         [data]="perCategoriaChart"
                         [options]="pieChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}"
                         (onDataSelect)="onCategoriaClick($event)">
                </p-chart>
              }
            </div>
          </p-card>

          <!-- FAMIGLIE con drill-down -->
          <p-card class="chart-card chart-medium chart-famiglia">
            <ng-template pTemplate="header">
              <div class="chart-header-with-back">
                @if (famigliaDrillDown.active) {
                  <p-button
                    icon="pi pi-arrow-left"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    (onClick)="backFromFamigliaDrillDown()"
                    [pTooltip]="t(1680, 'Indietro')">
                  </p-button>
                  <span class="chart-title">{{ t(1683, 'Clienti per') }}: {{ famigliaDrillDown.famigliaName }}</span>
                } @else {
                  <span class="chart-title">{{ t(1556, 'Top Famiglie Prodotti') }}</span>
                  <span class="chart-hint">{{ t(1682, 'Click per dettaglio') }}</span>
                }
              </div>
            </ng-template>
            <div class="chart-container" [style.height]="famigliaDrillDown.active ? '450px' : '350px'">
              @if (famigliaDrillDown.active && famigliaDrillDown.chart) {
                <p-chart type="bar"
                         [data]="famigliaDrillDown.chart"
                         [options]="barChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}">
                </p-chart>
              } @else if (perFamigliaChart) {
                <p-chart type="doughnut"
                         [data]="perFamigliaChart"
                         [options]="pieChartOptions"
                         [style]="{'width': '100%', 'height': '100%'}"
                         (onDataSelect)="onFamigliaClick($event)">
                </p-chart>
              }
            </div>
          </p-card>

        </div>

        <!-- TABLES ROW -->
        <div class="charts-row">

          <!-- Top Clienti Table -->
          <p-card [header]="t(1557, 'Dettaglio Top Clienti')" class="chart-card chart-large chart-clienti">
            <p-table [value]="dashboardData.top_clienti"
                     [paginator]="true"
                     [rows]="5"
                     [showCurrentPageReport]="true"
                     responsiveLayout="scroll">
              <ng-template pTemplate="header">
                <tr>
                  <th>{{ t(1558, 'Cliente') }}</th>
                  <th class="text-right">{{ t(1559, 'Fatturato') }}</th>
                  <th class="text-right">{{ t(1560, 'Quantit√† (kg)') }}</th>
                  <th class="text-right">{{ t(1561, 'Margine') }}</th>
                  <th class="text-right">{{ t(1562, 'Margine %') }}</th>
                  <th class="text-center">{{ t(1538, 'Ordini') }}</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-cliente>
                <tr>
                  <td>{{ cliente.cliente }}</td>
                  <td class="text-right">{{ formatCurrency(cliente.fatturato) }}</td>
                  <td class="text-right">{{ formatNumber(cliente.quantita, 2) }}</td>
                  <td class="text-right">{{ formatCurrency(cliente.margine) }}</td>
                  <td class="text-right">{{ formatPercent(cliente.margine_pct) }}</td>
                  <td class="text-center">{{ cliente.num_ordini }}</td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>

          <!-- Top Prodotti Table -->
          <p-card [header]="t(1563, 'Dettaglio Top Prodotti')" class="chart-card chart-large chart-prodotti">
            <p-table [value]="dashboardData.top_prodotti"
                     [paginator]="true"
                     [rows]="5"
                     [showCurrentPageReport]="true"
                     responsiveLayout="scroll">
              <ng-template pTemplate="header">
                <tr>
                  <th>{{ t(1564, 'Prodotto') }}</th>
                  <th class="text-right">{{ t(1559, 'Fatturato') }}</th>
                  <th class="text-right">{{ t(1560, 'Quantit√† (kg)') }}</th>
                  <th class="text-right">{{ t(1561, 'Margine') }}</th>
                  <th class="text-right">{{ t(1562, 'Margine %') }}</th>
                  <th class="text-center">{{ t(1538, 'Ordini') }}</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-prodotto>
                <tr>
                  <td>{{ prodotto.prodotto }}</td>
                  <td class="text-right">{{ formatCurrency(prodotto.fatturato) }}</td>
                  <td class="text-right">{{ formatNumber(prodotto.quantita, 2) }}</td>
                  <td class="text-right">{{ formatCurrency(prodotto.margine) }}</td>
                  <td class="text-right">{{ formatPercent(prodotto.margine_pct) }}</td>
                  <td class="text-center">{{ prodotto.num_ordini }}</td>
                </tr>
              </ng-template>
            </p-table>
          </p-card>

        </div>

      }

      <!-- NO DATA -->
      @if (!dashboardLoading && !dashboardData) {
        <div class="no-data-container">
          <i class="pi pi-file-excel" style="font-size: 3rem; color: #217346;"></i>
          <p>{{ t(1565, 'Nessun dato disponibile') }}</p>
          <p class="no-data-hint">{{ t(1593, 'Carica un file Excel per visualizzare la dashboard') }}</p>

          <!-- Pulsante per caricare dati dalla cache -->
          @if (hasCachedData && cachedDataInfo) {
            <div class="cache-info-box">
              <i class="pi pi-database"></i>
              <div class="cache-details">
                <span class="cache-label">{{ t(1594, 'Dati precedenti disponibili:') }}</span>
                <span class="cache-meta">
                  {{ cachedDataInfo.recordCount }} {{ t(1595, 'record') }}
                  @if (cachedDataInfo.fileName) {
                    - {{ cachedDataInfo.fileName }}
                  }
                </span>
                @if (cachedDataInfo.uploadedBy) {
                  <span class="cache-upload-info">
                    {{ t(1677, 'Uploaded by') }}: {{ cachedDataInfo.uploadedBy }}
                  </span>
                }
                @if (cachedDataInfo.updatedAt) {
                  <span class="cache-upload-info">
                    {{ t(1678, 'Date') }}: {{ formatCacheDate(cachedDataInfo.updatedAt) }}
                  </span>
                }
              </div>
              <div class="cache-actions">
                <p-button
                  icon="pi pi-download"
                  [label]="t(1596, 'Carica Ultimi Dati')"
                  (onClick)="loadCachedData()"
                  [loading]="cacheLoading">
                </p-button>
                <p-button
                  icon="pi pi-trash"
                  severity="danger"
                  [text]="true"
                  [pTooltip]="t(1597, 'Elimina cache')"
                  tooltipPosition="bottom"
                  tooltipStyleClass="cache-tooltip"
                  (onClick)="clearCachedData()">
                </p-button>
              </div>
            </div>
          }
        </div>
      }

    </div>
  }

  <app-gts-message
    [prjId]="prjId"
    [formId]="formId"
  ></app-gts-message>

  <!-- GTS AI Analyzer Component (reusable) -->
  <app-gts-ai-analyzer
    [data]="gtsAiAnalyzerData"
    [config]="gtsAiAnalyzerConfig"
    [(visible)]="showGtsAiAnalyzer">
  </app-gts-ai-analyzer>
</div>
