<!-- GTS AI Chat Component -->
<p-toast></p-toast>

<!-- Main Dialog -->
<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="true"
  [resizable]="false"
  [appendTo]="'body'"
  [blockScroll]="true"
  [style]="{ width: config.dialogWidth || '700px', maxWidth: '95vw', height: config.dialogHeight || '80vh' }"
  [closable]="true"
  (onShow)="onDialogShow()"
  (onHide)="onDialogHide()">

  <!-- Header buttons -->
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <span class="dialog-title">{{ dialogTitle }}</span>
      <div class="header-actions">
        <!-- Help Button -->
        <p-button
          icon="pi pi-question-circle"
          [rounded]="true"
          [text]="true"
          severity="secondary"
          (onClick)="helpVisible = true"
          pTooltip="Come usare la chat"
          class="help-btn">
        </p-button>
        @if (config.showClearButton && messages.length > 0) {
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            severity="secondary"
            (onClick)="clearChat()"
            pTooltip="Pulisci chat"
            class="clear-btn">
          </p-button>
        }
      </div>
    </div>
  </ng-template>

  <div class="ai-chat-container">
    <!-- Loading State -->
    @if (loading) {
      <div class="chat-loading">
        <p-progressSpinner [style]="{ width: '50px', height: '50px' }"></p-progressSpinner>
        <p>Inizializzazione chat...</p>
      </div>
    }

    <!-- Error State -->
    @if (error && !loading) {
      <div class="chat-error">
        <i class="pi pi-exclamation-triangle"></i>
        <p>{{ error }}</p>
        <p-button label="Riprova" icon="pi pi-refresh" (onClick)="onDialogShow()"></p-button>
      </div>
    }

    <!-- Chat Content -->
    @if (!loading && !error && sessionId) {
      <!-- Messages Area -->
      <div class="messages-container" #messagesContainer>
        <!-- Welcome / Empty State -->
        @if (messages.length === 0) {
          <div class="chat-welcome">
            <i class="pi pi-comments"></i>
            <h3>{{ chatConfig?.chatName || 'AI Chat' }}</h3>
            @if (chatConfig?.welcomeMessage) {
              <p>{{ chatConfig.welcomeMessage }}</p>
            }

            <!-- Suggested Questions -->
            @if (suggestedQuestions.length > 0) {
              <div class="suggested-questions">
                <p class="suggestions-label">Domande suggerite:</p>
                <div class="suggestions-list">
                  @for (question of suggestedQuestions; track question) {
                    <button class="suggestion-btn" (click)="useSuggestedQuestion(question)">
                      {{ question }}
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        }

        <!-- Message List -->
        @for (message of messages; track $index) {
          <div class="message" [class.user]="message.role === 'user'" [class.assistant]="message.role === 'assistant'">
            <!-- Avatar -->
            <div class="message-avatar">
              @if (message.role === 'user') {
                <i class="pi pi-user"></i>
              } @else {
                <i class="pi pi-sparkles"></i>
              }
            </div>

            <!-- Content -->
            <div class="message-content">
              <!-- Attachments (for user messages) -->
              @if (message.attachments && message.attachments.length > 0) {
                <div class="message-attachments">
                  @for (att of message.attachments; track att.fileName) {
                    <div class="attachment-chip">
                      <i class="pi" [class.pi-image]="att.type === 'image'" [class.pi-file-pdf]="att.type === 'document'"></i>
                      <span>{{ att.fileName }}</span>
                    </div>
                  }
                </div>
              }

              <!-- Text Content -->
              @if (message.isStreaming) {
                <div class="streaming-indicator">
                  <span class="thinking-text">L'AI sta elaborando</span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                </div>
              } @else {
                @if (message.role === 'assistant') {
                  <div class="markdown-content" [innerHTML]="renderMarkdown(message.content)"></div>
                } @else {
                  <div class="text-content">{{ message.content }}</div>
                }
              }

              <!-- Timestamp -->
              <div class="message-time">{{ formatTime(message.timestamp) }}</div>
            </div>
          </div>
        }
      </div>

      <!-- Apply Data Bar (appears when array is detected and context is grid) -->
      @if (detectedArrayData && detectedArrayRowCount > 0 && config.contextType === 'grid') {
        <div class="apply-data-bar">
          <div class="apply-data-info">
            <i class="pi pi-database"></i>
            <span>Rilevati <strong>{{ detectedArrayRowCount }}</strong> record pronti per l'import</span>
          </div>
          <div class="apply-data-buttons">
            <p-button
              label="Aggiungi"
              icon="pi pi-plus"
              severity="info"
              size="small"
              (onClick)="applyDetectedData('append')"
              pTooltip="Aggiunge i dati alla griglia esistente">
            </p-button>
            <p-button
              label="Sostituisci"
              icon="pi pi-refresh"
              severity="warn"
              size="small"
              (onClick)="applyDetectedData('replace')"
              pTooltip="Sostituisce tutti i dati della griglia">
            </p-button>
          </div>
        </div>
      }

      <!-- Input Area -->
      <div class="input-area">
        <!-- Pending Attachments -->
        @if (pendingAttachments.length > 0) {
          <div class="pending-attachments">
            @for (att of pendingAttachments; track $index) {
              <div class="attachment-preview">
                <i class="pi" [class.pi-image]="att.type === 'image'" [class.pi-file-pdf]="att.type === 'document'"></i>
                <span class="att-name">{{ att.fileName }}</span>
                <span class="att-size">{{ formatFileSize(att.fileSize || 0) }}</span>
                <button class="remove-att" (click)="removeAttachment($index)">
                  <i class="pi pi-times"></i>
                </button>
              </div>
            }
          </div>
        }

        <!-- Input Row -->
        <div class="input-row">
          <!-- File Upload Button -->
          @if (allowFileUpload) {
            <label class="upload-btn" pTooltip="Allega file">
              <i class="pi pi-paperclip"></i>
              <input
                type="file"
                [accept]="acceptFileTypes"
                (change)="onFileSelect($event)"
                [multiple]="true"
                hidden>
            </label>
          }

          <!-- Text Input -->
          <textarea
            #messageInput
            pTextarea
            [(ngModel)]="userMessage"
            [rows]="1"
            [autoResize]="true"
            placeholder="Scrivi un messaggio..."
            class="message-input"
            (keydown)="onKeyDown($event)"
            (paste)="onPaste($event)"
            [disabled]="sendingMessage">
          </textarea>

          <!-- Send Button -->
          <p-button
            icon="pi pi-send"
            [rounded]="true"
            [text]="true"
            severity="primary"
            (onClick)="sendMessage()"
            [disabled]="!userMessage.trim() || sendingMessage"
            [loading]="sendingMessage"
            pTooltip="Invia messaggio">
          </p-button>
        </div>

        <!-- Hint -->
        <div class="input-hint">
          <span>Premi <kbd>Invio</kbd> per inviare, <kbd>Shift+Invio</kbd> per nuova riga. Puoi incollare immagini con <kbd>Ctrl+V</kbd></span>
        </div>
      </div>
    }
  </div>
</p-dialog>

<!-- Help Popup -->
<p-dialog
  [(visible)]="helpVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '500px', maxWidth: '90vw' }"
  header="Come usare la chat">
  <div class="help-content">
    @if (chatConfig?.helpText) {
      <div [innerHTML]="renderMarkdown(chatConfig.helpText)"></div>
    } @else {
      <!-- Default help text -->
      <div class="help-section">
        <h4><i class="pi pi-send"></i> Inviare messaggi</h4>
        <ul>
          <li>Scrivi il messaggio e premi <kbd>Invio</kbd> per inviare</li>
          <li>Usa <kbd>Shift+Invio</kbd> per andare a capo senza inviare</li>
        </ul>
      </div>
      <div class="help-section">
        <h4><i class="pi pi-paperclip"></i> Allegare file</h4>
        <ul>
          <li>Clicca l'icona <i class="pi pi-paperclip"></i> per allegare file</li>
          <li>Puoi incollare immagini direttamente con <kbd>Ctrl+V</kbd></li>
          <li>I file Excel vengono convertiti automaticamente in CSV</li>
        </ul>
      </div>
      <div class="help-section">
        <h4><i class="pi pi-sparkles"></i> Suggerimenti</h4>
        <ul>
          <li>Sii specifico nelle tue richieste</li>
          <li>Puoi fare domande di follow-up</li>
          <li>L'AI ricorda il contesto della conversazione</li>
        </ul>
      </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Ho capito" icon="pi pi-check" (onClick)="helpVisible = false"></p-button>
  </ng-template>
</p-dialog>
